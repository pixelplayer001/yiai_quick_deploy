'use strict';function _0x2ed1(){const _0x42371e=['payMpaySecret','OrderEntity','payMpayNotifyUrl','40wiicFk','HttpStatus','payWeChatH5Name','__metadata','out_trade_no','124wgiRuI','微信支付通知params:\x20','param','订单不存在!','payWeChatAppId','notifyMpay','11RxUlOY','payHupiNotifyUrl','payEpayNotifyUrl','trade_status','payMpay','@nestjs/typeorm','TRANSACTION.SUCCESS','status:\x20','套餐不存在!','hash','failed','__decorate','@nestjs/common','appid','payEpay','trade_state','189932YCPLQQ','userBalanceService','axios','1078odWjLY','payWeChatNotifyUrl','defineProperty','createRandomNonceStr','now','PayService','UserBalanceService','payMpayApiPayUrl','wechat','payWeChatSecret','affected','errRaw','payHupiSecret','total_fee','payHupiReturnUrl','act','Repository','resource','name','payPlatform','toFixed','total','sort','query','InjectRepository','hupi','function','wechat-pay:\x20','UserService','192.168.1.100','attach','text','https://api.xunhupay.com/payment/query.html','notify_url','payWeChatPrivateKey','notify','sign','payMpayReturnUrl','get','SUCCESS','payMpayPid','__esModule','queryWeChat','createHash','payEpayApiPayUrl','getOpenIdByUserId','unsupported\x20pay\x20type','937572uPBCHw','log','10QhKkhm','status','payWeChatH5Url','513108QILiKs','30JWvEVZ','update','shift','payWeChat','https://api.xunhupay.com/payment/do.html','../order/order.entity','27062AWKkFK','default','GlobalConfigService','crypto','onModuleInit','1408833zuvruf','131480DEuGdC','HttpException','toString','trade_order_id','typeorm','notifyWeChat','payWeChatPublicKey','metadata','message','time','../userBalance/userBalance.service','payer','wx-native','importDynamic','design:paramtypes','24fzQAEw','mpay','post','decipher_gcm','../crami/cramiPackage.entity','38914044NKkrKM','payEpaySecret','getOwnPropertyDescriptor','BAD_REQUEST','money','支付请求失败!','getConfigs','../globalConfig/globalConfig.service','Wap','pay','jsapi支付结果返回值:\x20','keys','decorate','WxPay','success','h5_info','130328ciEdcT','payEpayPid','校验签名通过','本次支付类型:\x20','nonce_str','../user/user.service','notifyEpay','payWeChatMchId','wechatpay-node-v3','TRADE_SUCCESS','object','findOne','362001YEcEbg','out_trade_order','title','length','618DsNGWl','Injectable','type','globalConfigService','addBalanceToOrder','error:\x20','校验签名','payMpayApiQueryUrl','wxpay','11656HlZRpI','return_url','native','md5','includes','payHupiAppId','response','event_type','31565lDVyKy','pid','push','submit.php','clientip','goodsId','payType:\x20','data','cramiPackageEntity','notifyHupi','epay','queryHupi','362VECIdp','orderEntity'];_0x2ed1=function(){return _0x42371e;};return _0x2ed1();}const _0x3b42f1=_0x19aa;(function(_0x58967a,_0x3f034c){const _0x451e73=_0x19aa,_0x15c325=_0x58967a();while(!![]){try{const _0x1c72fc=-parseInt(_0x451e73(0x150))/0x1+-parseInt(_0x451e73(0x182))/0x2+-parseInt(_0x451e73(0x1a3))/0x3*(parseInt(_0x451e73(0x187))/0x4)+-parseInt(_0x451e73(0x194))/0x5*(parseInt(_0x451e73(0x188))/0x6)+-parseInt(_0x451e73(0x153))/0x7*(parseInt(_0x451e73(0x1d1))/0x8)+-parseInt(_0x451e73(0x193))/0x9*(parseInt(_0x451e73(0x1ea))/0xa)+-parseInt(_0x451e73(0x140))/0xb*(-parseInt(_0x451e73(0x1a8))/0xc);if(_0x1c72fc===_0x3f034c)break;else _0x15c325['push'](_0x15c325['shift']());}catch(_0x1b3561){_0x15c325['push'](_0x15c325['shift']());}}}(_0x2ed1,0x8c999));function _0x19aa(_0x449a7a,_0x1782dc){const _0x2ed1b8=_0x2ed1();return _0x19aa=function(_0x19aaef,_0x141e7f){_0x19aaef=_0x19aaef-0x13f;let _0x4c1006=_0x2ed1b8[_0x19aaef];return _0x4c1006;},_0x19aa(_0x449a7a,_0x1782dc);}const _0x42adb5=_0x404e;(function(_0x382a51,_0x151845){const _0x4d85c9=_0x19aa,_0x4a054c=_0x404e,_0x5f5b36=_0x382a51();while(!![]){try{const _0x2fbf8f=parseInt(_0x4a054c(0x22b))/0x1*(parseInt(_0x4a054c(0x1c2))/0x2)+parseInt(_0x4a054c(0x1f3))/0x3+-parseInt(_0x4a054c(0x1f5))/0x4*(parseInt(_0x4a054c(0x1ce))/0x5)+-parseInt(_0x4a054c(0x1ff))/0x6*(-parseInt(_0x4a054c(0x1c1))/0x7)+parseInt(_0x4a054c(0x21a))/0x8+parseInt(_0x4a054c(0x1e3))/0x9+parseInt(_0x4a054c(0x21f))/0xa*(-parseInt(_0x4a054c(0x208))/0xb);if(_0x2fbf8f===_0x151845)break;else _0x5f5b36[_0x4d85c9(0x1db)](_0x5f5b36['shift']());}catch(_0x1c70f0){_0x5f5b36[_0x4d85c9(0x1db)](_0x5f5b36[_0x4d85c9(0x18a)]());}}}(_0x3bc2,0x53688));var __decorate=this&&this[_0x3b42f1(0x14b)]||function(_0x46e8b1,_0x484308,_0x4cd57d,_0x1488d0){const _0xdfe53=_0x3b42f1,_0x216795=_0x404e;var _0x925223=arguments[_0x216795(0x21e)],_0xc36cf4=_0x925223<0x3?_0x484308:_0x1488d0===null?_0x1488d0=Object[_0x216795(0x213)](_0x484308,_0x4cd57d):_0x1488d0,_0x5452af;if(typeof Reflect===_0x216795(0x1ee)&&typeof Reflect[_0x216795(0x210)]===_0x216795(0x1a8))_0xc36cf4=Reflect[_0x216795(0x210)](_0x46e8b1,_0x484308,_0x4cd57d,_0x1488d0);else{for(var _0xb731c1=_0x46e8b1[_0xdfe53(0x1c7)]-0x1;_0xb731c1>=0x0;_0xb731c1--)if(_0x5452af=_0x46e8b1[_0xb731c1])_0xc36cf4=(_0x925223<0x3?_0x5452af(_0xc36cf4):_0x925223>0x3?_0x5452af(_0x484308,_0x4cd57d,_0xc36cf4):_0x5452af(_0x484308,_0x4cd57d))||_0xc36cf4;}return _0x925223>0x3&&_0xc36cf4&&Object[_0xdfe53(0x155)](_0x484308,_0x4cd57d,_0xc36cf4),_0xc36cf4;},__metadata=this&&this[_0x42adb5(0x203)]||function(_0x2fee8f,_0x30f344){const _0x5dd566=_0x42adb5;if(typeof Reflect===_0x5dd566(0x1ee)&&typeof Reflect[_0x5dd566(0x1f9)]===_0x5dd566(0x1a8))return Reflect[_0x5dd566(0x1f9)](_0x2fee8f,_0x30f344);},__param=this&&this[_0x42adb5(0x1c6)]||function(_0x14c928,_0x3693b1){return function(_0x3d9868,_0x8d0be3){_0x3693b1(_0x3d9868,_0x8d0be3,_0x14c928);};};Object[_0x42adb5(0x1ad)](exports,_0x42adb5(0x20f),{'value':!![]}),exports[_0x42adb5(0x1a2)]=void 0x0;const typeorm_1=require(_0x42adb5(0x206)),typeorm_2=require(_0x42adb5(0x21d)),common_1=require(_0x42adb5(0x1bc)),crypto=require(_0x42adb5(0x1a5)),axios_1=require(_0x42adb5(0x1fd)),order_entity_1=require(_0x42adb5(0x1b7)),cramiPackage_entity_1=require(_0x42adb5(0x24a)),userBalance_service_1=require(_0x42adb5(0x1e8)),globalConfig_service_1=require(_0x3b42f1(0x1af)),utils_1=require(_0x42adb5(0x247)),user_service_1=require(_0x42adb5(0x1cf));let PayService=class PayService{constructor(_0x44a4dc,_0x1399e6,_0x2ecd3,_0x2ed9f3,_0xa6965){const _0x5ce04c=_0x3b42f1,_0x555dda=_0x42adb5;this[_0x555dda(0x1af)]=_0x44a4dc,this[_0x5ce04c(0x1e6)]=_0x1399e6,this[_0x555dda(0x1b1)]=_0x2ecd3,this[_0x555dda(0x212)]=_0x2ed9f3,this[_0x555dda(0x22d)]=_0xa6965;}async[_0x3b42f1(0x192)](){const _0x2a6164=_0x3b42f1,_0x3fe1ba=_0x42adb5,_0x16fbce=await(0x0,utils_1[_0x3fe1ba(0x1e7)])(_0x2a6164(0x1c0));this[_0x2a6164(0x1b5)]=(_0x16fbce===null||_0x16fbce===void 0x0?void 0x0:_0x16fbce[_0x3fe1ba(0x1c7)])?_0x16fbce[_0x3fe1ba(0x1c7)]:_0x16fbce;}async[_0x42adb5(0x1a3)](_0x4fc0bc){const _0x4c8bd7=_0x3b42f1,_0x4b2364=_0x42adb5;if(_0x4fc0bc[_0x4b2364(0x1d6)]==_0x4b2364(0x1f0))return this[_0x4b2364(0x1d7)](_0x4fc0bc);if(_0x4fc0bc[_0x4b2364(0x217)]==_0x4c8bd7(0x16c))return this[_0x4c8bd7(0x1e2)](_0x4fc0bc);if(typeof _0x4fc0bc[_0x4b2364(0x226)]==_0x4b2364(0x1ee))return this[_0x4b2364(0x1ca)](_0x4fc0bc);return this[_0x4c8bd7(0x13f)](_0x4fc0bc);}async[_0x3b42f1(0x1b1)](_0x474492,_0x2b820b,_0x765630=_0x42adb5(0x1f6)){const _0x37c6be=_0x3b42f1,_0x2f737e=_0x42adb5,_0x19e3ad=await this[_0x2f737e(0x1c3)][_0x37c6be(0x1c3)]({'where':{'userId':_0x474492,'orderId':_0x2b820b}});if(!_0x19e3ad)throw new common_1[(_0x37c6be(0x195))](_0x37c6be(0x1f2),common_1[_0x2f737e(0x23e)][_0x2f737e(0x209)]);const _0x246dd4=await this[_0x37c6be(0x1e1)][_0x2f737e(0x1b5)]({'where':{'id':_0x19e3ad['goodsId']}});if(!_0x246dd4)throw new common_1[(_0x2f737e(0x1e9))](_0x2f737e(0x1bf),common_1[_0x2f737e(0x23e)][_0x37c6be(0x1ab)]);console[_0x37c6be(0x183)](_0x37c6be(0x1bb),_0x19e3ad[_0x2f737e(0x1ac)]);try{if(_0x19e3ad[_0x37c6be(0x166)]==_0x2f737e(0x1d0))return this[_0x2f737e(0x1ba)](_0x474492,_0x2b820b,_0x765630);if(_0x19e3ad[_0x37c6be(0x166)]==_0x2f737e(0x1f0))return this[_0x37c6be(0x14e)](_0x474492,_0x2b820b,_0x765630);if(_0x19e3ad[_0x2f737e(0x1ac)]==_0x2f737e(0x1c5))return this[_0x37c6be(0x144)](_0x474492,_0x2b820b,_0x765630);if(_0x19e3ad[_0x2f737e(0x1ac)]==_0x37c6be(0x16c))return this[_0x2f737e(0x1df)](_0x474492,_0x2b820b,_0x765630);}catch(_0x3c0e01){console[_0x37c6be(0x183)](_0x2f737e(0x243),_0x3c0e01);throw new common_1[(_0x2f737e(0x1e9))](_0x2f737e(0x21b),common_1[_0x2f737e(0x23e)][_0x2f737e(0x209)]);}}async[_0x42adb5(0x24d)](_0x11084b){const _0x552996=_0x3b42f1,_0x28dc08=_0x42adb5,_0x235954=await this[_0x28dc08(0x1c3)][_0x552996(0x1c3)]({'where':{'orderId':_0x11084b}});if(!_0x235954)throw new common_1[(_0x28dc08(0x1e9))](_0x28dc08(0x1f2),common_1[_0x552996(0x1eb)]['BAD_REQUEST']);return _0x235954;}async['notifyHupi'](_0x4c2d03){const _0x7dc9f4=_0x3b42f1,_0x430c46=_0x42adb5,_0x18e3e8=await this[_0x430c46(0x212)]['getConfigs']([_0x430c46(0x1be)]),_0x21c0ce=_0x4c2d03['hash'];delete _0x4c2d03[_0x430c46(0x1fb)];if(this['sign'](_0x4c2d03,_0x18e3e8)!=_0x21c0ce)return _0x430c46(0x207);const _0x36542b=await this[_0x430c46(0x1c3)][_0x430c46(0x1b5)]({'where':{'orderId':_0x4c2d03[_0x430c46(0x234)],'status':0x0}});if(!_0x36542b)return _0x7dc9f4(0x14a);await this[_0x7dc9f4(0x151)][_0x430c46(0x1b2)](_0x36542b);const _0x29e817=await this[_0x430c46(0x1c3)][_0x430c46(0x1d2)]({'orderId':_0x4c2d03[_0x430c46(0x234)]},{'status':0x1,'paydAt':new Date()});if(_0x29e817[_0x430c46(0x24f)]!=0x1)return _0x7dc9f4(0x14a);return _0x7dc9f4(0x1b6);}async[_0x42adb5(0x1df)](_0x43a916,_0x413c94,_0x23795e=_0x42adb5(0x1f6)){const _0x3d4874=_0x3b42f1,_0x13b45f=_0x42adb5,_0x3125d0=await this[_0x3d4874(0x1e6)][_0x13b45f(0x1b5)]({'where':{'userId':_0x43a916,'orderId':_0x413c94}});if(!_0x3125d0)throw new common_1['HttpException'](_0x3d4874(0x1f2),common_1[_0x13b45f(0x23e)][_0x3d4874(0x1ab)]);const _0x4a0317=await this[_0x13b45f(0x1af)][_0x13b45f(0x1b5)]({'where':{'id':_0x3125d0[_0x13b45f(0x22c)]}});if(!_0x4a0317)throw new common_1[(_0x13b45f(0x1e9))](_0x13b45f(0x1bf),common_1['HttpStatus'][_0x3d4874(0x1ab)]);const {payHupiAppId:_0x59c3db,payHupiSecret:_0x5b1dac,payHupiNotifyUrl:_0x857bb2,payHupiReturnUrl:_0x313ed1,payHupiGatewayUrl:_0x5c1e23}=await this[_0x13b45f(0x212)][_0x13b45f(0x1cd)]([_0x13b45f(0x1b9),_0x13b45f(0x1be),_0x3d4874(0x141),_0x13b45f(0x220),_0x13b45f(0x20b)]),_0x5e2cdd={};_0x5e2cdd[_0x13b45f(0x249)]=_0x13b45f(0x232),_0x5e2cdd[_0x13b45f(0x227)]=_0x59c3db,_0x5e2cdd[_0x13b45f(0x1b6)]=(Date[_0x3d4874(0x157)]()/0x3e8)[_0x13b45f(0x244)](0x0),_0x5e2cdd['nonce_str']=(0x0,utils_1[_0x13b45f(0x1b8)])(0x20),_0x5e2cdd['trade_order_id']=_0x413c94,_0x5e2cdd[_0x13b45f(0x246)]=_0x4a0317[_0x13b45f(0x1c0)],_0x5e2cdd[_0x13b45f(0x1c9)]=_0x3125d0[_0x13b45f(0x1cb)],_0x5e2cdd[_0x3d4874(0x174)]=_0x857bb2,_0x5e2cdd[_0x13b45f(0x24e)]=_0x313ed1,_0x5e2cdd[_0x3d4874(0x171)]='hupi',_0x5e2cdd[_0x13b45f(0x1fb)]=this['sign'](_0x5e2cdd,_0x5b1dac);const {data:{errcode:_0x1687d4,errmsg:_0x4a589c,url_qrcode:_0x10af63,url:_0x5997e1}}=await axios_1['default'][_0x3d4874(0x1a5)](_0x5c1e23||_0x13b45f(0x1a6),_0x5e2cdd);if(_0x1687d4!=0x0)throw new common_1[(_0x13b45f(0x1e9))](_0x4a589c,common_1[_0x13b45f(0x23e)][_0x3d4874(0x1ab)]);return{'url_qrcode':_0x10af63,'url':_0x5997e1};}async[_0x3b42f1(0x1e4)](_0x2fee38){const _0x116b67=_0x3b42f1,_0x11985d=_0x42adb5,{payHupiAppId:_0x3ac00a,payHupiSecret:_0x33e7a4}=await this[_0x116b67(0x1cb)][_0x11985d(0x1cd)]([_0x11985d(0x1b9),_0x11985d(0x1be)]),_0x3f164d={};_0x3f164d[_0x11985d(0x249)]=_0x11985d(0x232),_0x3f164d[_0x11985d(0x227)]=_0x3ac00a,_0x3f164d[_0x11985d(0x1b6)]=(Date[_0x11985d(0x237)]()/0x3e8)[_0x11985d(0x244)](0x0),_0x3f164d[_0x11985d(0x236)]=(0x0,utils_1[_0x11985d(0x1b8)])(0x20),_0x3f164d[_0x11985d(0x1ae)]=_0x2fee38,_0x3f164d[_0x11985d(0x1fb)]=this[_0x11985d(0x222)](_0x3f164d,_0x33e7a4);const {data:{errcode:_0x1e26a6,errmsg:_0x5e8312,data:_0x4e0035}}=await axios_1[_0x11985d(0x1c7)][_0x11985d(0x240)](_0x11985d(0x22f),_0x3f164d);if(_0x1e26a6!=0x0)throw new common_1[(_0x11985d(0x1e9))](_0x5e8312,common_1[_0x11985d(0x23e)][_0x11985d(0x209)]);return _0x4e0035;}async[_0x42adb5(0x1d7)](_0x1eacd0){const _0x29a53b=_0x3b42f1,_0x336071=_0x42adb5,_0x2eb1f4=_0x1eacd0[_0x336071(0x222)];delete _0x1eacd0[_0x336071(0x222)],delete _0x1eacd0[_0x336071(0x23a)];const _0x419a52=await this[_0x29a53b(0x1cb)][_0x336071(0x1cd)]([_0x336071(0x233)]);if(this[_0x336071(0x222)](_0x1eacd0,_0x419a52)!=_0x2eb1f4)return _0x336071(0x207);console[_0x336071(0x1a9)](_0x29a53b(0x1ba));const _0x5365f3=await this[_0x336071(0x1c3)][_0x29a53b(0x1c3)]({'where':{'orderId':_0x1eacd0[_0x336071(0x223)],'status':0x0}});if(!_0x5365f3)return _0x336071(0x207);const _0x2f092e=_0x1eacd0[_0x336071(0x229)]==_0x29a53b(0x1c1)?0x1:0x2,_0x4125fd=await this[_0x336071(0x1c3)][_0x336071(0x1d2)]({'orderId':_0x1eacd0[_0x29a53b(0x1ee)]},{'status':_0x2f092e,'paydAt':new Date()});_0x2f092e===0x1&&await this[_0x336071(0x1b1)][_0x336071(0x1b2)](_0x5365f3);if(_0x4125fd['affected']!=0x1)return _0x336071(0x207);return _0x29a53b(0x1b6);}async[_0x42adb5(0x1c4)](_0x2fbf0e,_0x42aabd,_0x3939ff=_0x42adb5(0x1eb)){const _0x56ddcc=_0x3b42f1,_0x5b6f8a=_0x42adb5,_0x44eba6=await this[_0x5b6f8a(0x1c3)][_0x56ddcc(0x1c3)]({'where':{'userId':_0x2fbf0e,'orderId':_0x42aabd}});if(!_0x44eba6)throw new common_1[(_0x5b6f8a(0x1e9))](_0x5b6f8a(0x1f2),common_1[_0x56ddcc(0x1eb)][_0x5b6f8a(0x209)]);const _0x2a544c=await this[_0x5b6f8a(0x1af)][_0x5b6f8a(0x1b5)]({'where':{'id':_0x44eba6[_0x5b6f8a(0x22c)]}});if(!_0x2a544c)throw new common_1[(_0x5b6f8a(0x1e9))](_0x5b6f8a(0x1bf),common_1[_0x5b6f8a(0x23e)][_0x5b6f8a(0x209)]);const {payEpayPid:_0x2a2c86,payEpaySecret:_0x4f567c,payEpayNotifyUrl:_0x4b4448,payEpayReturnUrl:_0x5f2ec2,payEpayApiPayUrl:_0x3778c7}=await this[_0x5b6f8a(0x212)][_0x5b6f8a(0x1cd)]([_0x5b6f8a(0x242),_0x5b6f8a(0x233),_0x56ddcc(0x142),_0x5b6f8a(0x1c8),_0x56ddcc(0x17f)]);let _0x27e011;_0x2a2c86[_0x5b6f8a(0x21e)]<=0x10?_0x27e011=Number(_0x2a2c86):_0x27e011=BigInt(_0x2a2c86);const _0x3f1a50={};_0x3f1a50[_0x5b6f8a(0x235)]=_0x27e011,_0x3f1a50[_0x5b6f8a(0x248)]=_0x3939ff,_0x3f1a50[_0x56ddcc(0x1ee)]=_0x42aabd,_0x3f1a50[_0x5b6f8a(0x1c0)]=_0x2a544c[_0x5b6f8a(0x1c0)],_0x3f1a50[_0x5b6f8a(0x1ec)]=_0x44eba6[_0x56ddcc(0x168)],_0x3f1a50[_0x5b6f8a(0x250)]=_0x5b6f8a(0x221),_0x3f1a50[_0x5b6f8a(0x1ea)]='pc',_0x3f1a50[_0x5b6f8a(0x1bb)]=_0x4b4448,_0x3f1a50[_0x5b6f8a(0x24e)]=_0x5f2ec2,_0x3f1a50[_0x5b6f8a(0x1d6)]=_0x5b6f8a(0x1f0),_0x3f1a50[_0x5b6f8a(0x222)]=this[_0x56ddcc(0x177)](_0x3f1a50,_0x4f567c),_0x3f1a50[_0x5b6f8a(0x23a)]=_0x5b6f8a(0x231);const _0x87b0a0=new URLSearchParams(_0x3f1a50)[_0x5b6f8a(0x1a7)](),_0x1ebf38=_0x3778c7+'?'+_0x87b0a0;if(_0x3778c7[_0x5b6f8a(0x20a)](_0x5b6f8a(0x1fa)))return{'url_qrcode':null,'redirectUrl':_0x1ebf38,'channel':_0x3939ff,'isRedirect':!![]};else{const _0x4b497e=await axios_1[_0x56ddcc(0x18f)][_0x5b6f8a(0x1fe)](_0x3778c7,{'params':_0x3f1a50});console[_0x5b6f8a(0x1a9)](_0x5b6f8a(0x1e1),_0x4b497e[_0x56ddcc(0x1e0)]);const {data:{code:_0x457a69,msg:_0x1c7e9c,qrcode:_0x4c8df4}}=_0x4b497e;if(_0x457a69!=0x1)throw new common_1['HttpException'](_0x1c7e9c,common_1[_0x5b6f8a(0x23e)][_0x5b6f8a(0x209)]);return{'url_qrcode':_0x4c8df4,'redirectUrl':null,'channel':_0x3939ff,'isRedirect':![]};}}async[_0x42adb5(0x202)](_0x4cbfea){const _0x3da22f=_0x3b42f1,_0x243ebb=_0x42adb5,{payEpayPid:_0x51b41,payEpaySecret:_0xdf0ea3,payEpayApiQueryUrl:_0x4aee43}=await this[_0x243ebb(0x212)][_0x243ebb(0x1cd)]([_0x3da22f(0x1b9),_0x243ebb(0x233),_0x243ebb(0x239)]),_0x421718={};_0x421718[_0x243ebb(0x219)]=_0x243ebb(0x1f1),_0x421718['out_trade_no']=_0x4cbfea,_0x421718[_0x243ebb(0x235)]=_0x51b41,_0x421718[_0x243ebb(0x23c)]=_0xdf0ea3;const {data:{code:_0x371dff,msg:_0x5c3366,data:_0x5c4d2e}}=await axios_1['default'][_0x3da22f(0x179)](_0x4aee43,{'params':_0x421718});if(_0x371dff!=0x1)throw new common_1['HttpException'](_0x5c3366,common_1[_0x243ebb(0x23e)][_0x243ebb(0x209)]);return _0x5c4d2e;}async[_0x42adb5(0x216)](_0x41ba6b){const _0x5b77e3=_0x3b42f1,_0x309460=_0x42adb5,_0x40d70e=_0x41ba6b[_0x309460(0x222)];delete _0x41ba6b[_0x5b77e3(0x177)],delete _0x41ba6b[_0x309460(0x23a)];const _0x23cc29=await this[_0x5b77e3(0x1cb)][_0x309460(0x1cd)]([_0x309460(0x1de)]);console[_0x309460(0x1a9)](_0x309460(0x218));if(this[_0x309460(0x222)](_0x41ba6b,_0x23cc29)!=_0x40d70e)return _0x309460(0x207);console[_0x5b77e3(0x183)](_0x309460(0x245));const _0xb17f1c=await this[_0x309460(0x1c3)][_0x309460(0x1b5)]({'where':{'orderId':_0x41ba6b[_0x5b77e3(0x1ee)],'status':0x0}});if(!_0xb17f1c)return _0x309460(0x207);const _0x50658f=_0x41ba6b[_0x309460(0x229)]==_0x309460(0x1d4)?0x1:0x2;console[_0x309460(0x1a9)](_0x309460(0x1ed),_0x50658f);const _0x5d8757=await this[_0x309460(0x1c3)][_0x309460(0x1d2)]({'orderId':_0x41ba6b[_0x309460(0x223)]},{'status':_0x50658f,'paydAt':new Date()});_0x50658f===0x1&&await this[_0x309460(0x1b1)][_0x309460(0x1b2)](_0xb17f1c);if(_0x5d8757[_0x309460(0x24f)]!=0x1)return _0x309460(0x207);return _0x309460(0x201);}async[_0x3b42f1(0x144)](_0x1f01da,_0x175779,_0x321977=_0x42adb5(0x1f6)){const _0x2e6d9e=_0x3b42f1,_0x1d49f9=_0x42adb5,_0x413247=await this[_0x1d49f9(0x1c3)][_0x1d49f9(0x1b5)]({'where':{'userId':_0x1f01da,'orderId':_0x175779}});if(!_0x413247)throw new common_1[(_0x1d49f9(0x1e9))](_0x1d49f9(0x1f2),common_1[_0x1d49f9(0x23e)][_0x1d49f9(0x209)]);const _0x2e737b=await this[_0x1d49f9(0x1af)][_0x1d49f9(0x1b5)]({'where':{'id':_0x413247[_0x1d49f9(0x22c)]}});if(!_0x2e737b)throw new common_1[(_0x1d49f9(0x1e9))](_0x1d49f9(0x1bf),common_1[_0x1d49f9(0x23e)][_0x1d49f9(0x209)]);const {payMpayPid:_0x147d38,payMpaySecret:_0x5841e6,payMpayNotifyUrl:_0x144bfd,payMpayReturnUrl:_0x1ef50a,payMpayApiPayUrl:_0x1f68cf}=await this[_0x1d49f9(0x212)][_0x1d49f9(0x1cd)]([_0x1d49f9(0x1da),_0x2e6d9e(0x1e7),_0x1d49f9(0x205),_0x1d49f9(0x1d9),_0x2e6d9e(0x15a)]),_0x5c0429={};_0x5c0429[_0x2e6d9e(0x1da)]=Number(_0x147d38),_0x5c0429[_0x2e6d9e(0x1ca)]=_0x321977,_0x5c0429[_0x1d49f9(0x223)]=_0x175779,_0x5c0429[_0x1d49f9(0x1c0)]=_0x2e737b[_0x1d49f9(0x1c0)],_0x5c0429[_0x1d49f9(0x1ec)]=_0x413247[_0x1d49f9(0x1cb)],_0x5c0429[_0x1d49f9(0x1bb)]=_0x144bfd,_0x5c0429[_0x1d49f9(0x24e)]=_0x1ef50a,_0x5c0429[_0x2e6d9e(0x177)]=this['sign'](_0x5c0429,_0x5841e6),_0x5c0429[_0x1d49f9(0x23a)]=_0x1d49f9(0x231);const _0x295f96=new URLSearchParams(_0x5c0429)['toString'](),_0x4b9a96=_0x1f68cf+'?'+_0x295f96;return{'url_qrcode':null,'redirectUrl':_0x4b9a96,'channel':_0x321977,'isRedirect':!![]};const _0x29d7d9=await axios_1[_0x1d49f9(0x1c7)][_0x2e6d9e(0x179)](_0x1f68cf,{'params':_0x5c0429});}async[_0x42adb5(0x1dd)](_0x2b722c){const _0x372af1=_0x3b42f1,_0x560ae6=_0x42adb5,{payMpayApiQueryUrl:_0x3b300d}=await this[_0x560ae6(0x212)][_0x372af1(0x1ae)]([_0x560ae6(0x1da),_0x560ae6(0x1de),_0x560ae6(0x241)]),_0x5a11d0={};_0x5a11d0[_0x560ae6(0x248)]=0x2,_0x5a11d0[_0x560ae6(0x22e)]=_0x2b722c;const {data:{code:_0x580713,msg:_0x18e944,data:_0x27b9af}}=await axios_1['default']['get'](_0x3b300d,{'params':_0x5a11d0});if(_0x580713!=0x1)throw new common_1[(_0x560ae6(0x1e9))](_0x18e944,common_1[_0x560ae6(0x23e)][_0x560ae6(0x209)]);return _0x27b9af;}async[_0x3b42f1(0x199)](_0x4d8387){const _0x29c4ce=_0x3b42f1,_0xde8d9=_0x42adb5;console[_0xde8d9(0x1a9)](_0xde8d9(0x20d),_0x4d8387);const {payWeChatAppId:_0x34c297,payWeChatMchId:_0x569a9d,payWeChatSecret:_0x5c3af3,payWeChatPublicKey:_0x32ee8e,payWeChatPrivateKey:_0x282d46}=await this[_0xde8d9(0x212)][_0xde8d9(0x1cd)]([_0xde8d9(0x1f7),_0x29c4ce(0x1bf),_0xde8d9(0x1d5),_0xde8d9(0x21c),_0xde8d9(0x1db)]),_0x592b27=new this[(_0xde8d9(0x1ab))]({'appid':_0x34c297,'mchid':_0x569a9d,'publicKey':_0x32ee8e,'privateKey':_0x282d46});try{if(_0x4d8387[_0x29c4ce(0x1d8)]==_0xde8d9(0x1a4)){const {ciphertext:_0xd7167d,associated_data:_0x154ae8,nonce:_0x2a9db0}=_0x4d8387[_0xde8d9(0x226)],_0x49817c=_0x592b27[_0xde8d9(0x1b4)](_0xd7167d,_0x154ae8,_0x2a9db0,_0x5c3af3),_0x5dfa05=await this[_0xde8d9(0x1c3)][_0x29c4ce(0x1c3)]({'where':{'orderId':_0x49817c[_0xde8d9(0x223)],'status':0x0}});if(!_0x5dfa05)return'failed';const _0x4ba532=_0x49817c[_0x29c4ce(0x14f)]==_0xde8d9(0x214)?0x1:0x2,_0x28477e=await this[_0x29c4ce(0x1e6)][_0x29c4ce(0x189)]({'orderId':_0x49817c['out_trade_no']},{'status':_0x4ba532,'paydAt':new Date()});_0x4ba532===0x1&&await this[_0x29c4ce(0x151)][_0x29c4ce(0x1cc)](_0x5dfa05);if(_0x28477e[_0xde8d9(0x24f)]!=0x1)return _0xde8d9(0x207);}return'success';}catch(_0x165b7c){return console[_0xde8d9(0x1a9)](_0xde8d9(0x230),_0x165b7c),console[_0xde8d9(0x1a9)]('支付通知验证失败:\x20',_0x165b7c),_0x29c4ce(0x14a);}}async[_0x42adb5(0x1ba)](_0x37329d,_0x2c7586,_0x36fc39=_0x42adb5(0x23b)){const _0x194313=_0x3b42f1,_0xf41eaa=_0x42adb5;var _0x32eddc,_0x232f6d,_0x34eac5;console[_0xf41eaa(0x1a9)](_0xf41eaa(0x251),_0x36fc39);const _0x270696=await this[_0xf41eaa(0x1c3)][_0xf41eaa(0x1b5)]({'where':{'userId':_0x37329d,'orderId':_0x2c7586}});if(!_0x270696)throw new common_1[(_0xf41eaa(0x1e9))](_0xf41eaa(0x1f2),common_1[_0xf41eaa(0x23e)][_0xf41eaa(0x209)]);const _0x2fefa2=await this['cramiPackageEntity'][_0x194313(0x1c3)]({'where':{'id':_0x270696[_0xf41eaa(0x22c)]}});if(!_0x2fefa2)throw new common_1[(_0xf41eaa(0x1e9))](_0xf41eaa(0x1bf),common_1[_0xf41eaa(0x23e)][_0x194313(0x1ab)]);const {payWeChatAppId:_0x56c5ef,payWeChatMchId:_0x4231a4,payWeChatPublicKey:_0xa6395f,payWeChatPrivateKey:_0x19e18c,payWeChatNotifyUrl:_0x5a010e,payWeChatH5Name:_0x13d81b,payWeChatH5Url:_0x232a86}=await this[_0xf41eaa(0x212)][_0xf41eaa(0x1cd)]([_0xf41eaa(0x1f7),_0xf41eaa(0x24b),'payWeChatPublicKey',_0x194313(0x175),_0x194313(0x154),_0x194313(0x1ec),_0x194313(0x186)]),_0x2d539f=new this[(_0xf41eaa(0x1ab))]({'appid':_0x56c5ef,'mchid':_0x4231a4,'publicKey':_0xa6395f,'privateKey':_0x19e18c}),_0x4385f8={'appid':_0x56c5ef,'mchid':_0x4231a4,'description':_0x2fefa2[_0xf41eaa(0x1c0)],'out_trade_no':_0x2c7586,'notify_url':_0x5a010e,'amount':{'total':Number(_0x270696[_0x194313(0x168)]*0x64)},'scene_info':{'payer_client_ip':_0xf41eaa(0x221)}};console[_0xf41eaa(0x1a9)](_0xf41eaa(0x1dc),_0x4385f8);if(_0x36fc39=='h5'){_0x4385f8[_0xf41eaa(0x1f8)][_0x194313(0x1b7)]={'type':_0xf41eaa(0x1d8),'app_name':_0x13d81b,'app_url':_0x232a86};const _0x552995=await _0x2d539f[_0xf41eaa(0x1aa)](_0x4385f8);if(_0x552995[_0xf41eaa(0x1e4)]===0x193){const _0x42cc90=(_0x34eac5=(_0x232f6d=(_0x32eddc=_0x552995===null||_0x552995===void 0x0?void 0x0:_0x552995[_0x194313(0x15e)])===null||_0x32eddc===void 0x0?void 0x0:_0x32eddc[_0xf41eaa(0x1e0)])===null||_0x232f6d===void 0x0?void 0x0:_0x232f6d[_0xf41eaa(0x211)])===null||_0x34eac5===void 0x0?void 0x0:_0x34eac5[_0xf41eaa(0x1ef)];throw new common_1[(_0xf41eaa(0x1e9))]((_0x552995===null||_0x552995===void 0x0?void 0x0:_0x552995[_0xf41eaa(0x1ef)])||_0xf41eaa(0x238),common_1[_0xf41eaa(0x23e)][_0xf41eaa(0x209)]);}const {h5_url:_0x38dc00}=_0x552995;return{'url':_0x38dc00};}if(_0x36fc39==_0xf41eaa(0x1e6)){const _0x2ffc36=await this[_0xf41eaa(0x22d)][_0x194313(0x180)](_0x37329d);console[_0xf41eaa(0x1a9)](_0xf41eaa(0x24c),_0x2ffc36),_0x4385f8[_0xf41eaa(0x225)]={'openid':_0x2ffc36};const _0x4d9fc3=await _0x2d539f[_0xf41eaa(0x215)](_0x4385f8);return console[_0xf41eaa(0x1a9)](_0xf41eaa(0x1f4),_0x4d9fc3),_0x4d9fc3;}if(_0x36fc39==_0xf41eaa(0x23b)){const _0x3937ee=await _0x2d539f[_0xf41eaa(0x1d3)](_0x4385f8),{code_url:_0x282b82}=_0x3937ee;return!_0x282b82&&console[_0x194313(0x183)](_0xf41eaa(0x22a),_0x3937ee),{'url_qrcode':_0x282b82,'isRedirect':![]};}throw new common_1[(_0xf41eaa(0x1e9))](_0xf41eaa(0x224),common_1[_0x194313(0x1eb)][_0xf41eaa(0x209)]);}async[_0x42adb5(0x20e)](_0x2b9c27){const _0x1318e4=_0x42adb5,{payWeChatAppId:_0x2fd126,payWeChatMchId:_0x3944e2,payWeChatPublicKey:_0x182f96,payWeChatPrivateKey:_0x1fc2cb,payWeChatNotifyUrl:_0x4afba2,payWeChatH5Name:_0x356076,payWeChatH5Url:_0x230d14}=await this[_0x1318e4(0x212)][_0x1318e4(0x1cd)]([_0x1318e4(0x1f7),_0x1318e4(0x24b),_0x1318e4(0x21c),_0x1318e4(0x1db)]),_0x1b0bf7=new this[(_0x1318e4(0x1ab))]({'appid':_0x2fd126,'mchid':_0x3944e2,'publicKey':_0x182f96,'privateKey':_0x1fc2cb}),_0x5c5038=await _0x1b0bf7[_0x1318e4(0x24d)]({'out_trade_no':_0x2b9c27});return _0x5c5038;}['sign'](_0x518810,_0xa3e420){const _0x1fa289=_0x3b42f1,_0x5da4b0=_0x42adb5,_0x2c9293=Object[_0x5da4b0(0x228)](_0x518810)[_0x5da4b0(0x1b0)]()[_0x5da4b0(0x1e2)](_0x486842=>_0x486842+'='+_0x518810[_0x486842])['join']('&')+_0xa3e420;return crypto[_0x5da4b0(0x200)](_0x1fa289(0x1d4))[_0x5da4b0(0x1d2)](_0x2c9293)[_0x5da4b0(0x1d1)]('hex');}};function _0x404e(_0x58c929,_0x48350e){const _0x4827c1=_0x3bc2();return _0x404e=function(_0x433753,_0x5c251f){_0x433753=_0x433753-0x1a2;let _0x4da5b5=_0x4827c1[_0x433753];return _0x4da5b5;},_0x404e(_0x58c929,_0x48350e);}function _0x3bc2(){const _0x52f245=_0x3b42f1,_0x2ee3d8=[_0x52f245(0x1a9),_0x52f245(0x197),_0x52f245(0x1da),_0x52f245(0x1bc),'now','微信H5支付失败！','payEpayApiQueryUrl','sign_type',_0x52f245(0x1d3),'key',_0x52f245(0x190),_0x52f245(0x1eb),_0x52f245(0x16b),_0x52f245(0x1a5),_0x52f245(0x1cf),'payEpayPid','支付请求失败:\x20',_0x52f245(0x167),'校验签名通过',_0x52f245(0x1c6),'../../common/utils',_0x52f245(0x1ca),'version',_0x52f245(0x1a7),_0x52f245(0x1bf),'用户openId:\x20',_0x52f245(0x16a),_0x52f245(0x1d2),_0x52f245(0x15d),_0x52f245(0x1dd),_0x52f245(0x1df),_0x52f245(0x158),_0x52f245(0x176),_0x52f245(0x146),_0x52f245(0x191),_0x52f245(0x18c),_0x52f245(0x196),_0x52f245(0x16d),_0x52f245(0x183),'transactions_h5',_0x52f245(0x1b5),_0x52f245(0x166),_0x52f245(0x155),_0x52f245(0x1c5),_0x52f245(0x1e1),_0x52f245(0x169),'userBalanceService',_0x52f245(0x1cc),_0x52f245(0x163),_0x52f245(0x1a6),_0x52f245(0x1c3),_0x52f245(0x19d),_0x52f245(0x18d),_0x52f245(0x156),_0x52f245(0x1d6),_0x52f245(0x18b),_0x52f245(0x174),_0x52f245(0x14c),'CramiPackageEntity',_0x52f245(0x15f),_0x52f245(0x148),_0x52f245(0x165),_0x52f245(0x18e),_0x52f245(0x1e5),'orderEntity',_0x52f245(0x14e),_0x52f245(0x1a4),'__param',_0x52f245(0x18f),'payEpayReturnUrl',_0x52f245(0x160),_0x52f245(0x199),_0x52f245(0x168),_0x52f245(0x1a2),_0x52f245(0x1ae),_0x52f245(0x1d9),_0x52f245(0x1bd),_0x52f245(0x15b),'digest','update','transactions_native','TRADE_SUCCESS',_0x52f245(0x15c),_0x52f245(0x1f1),_0x52f245(0x1be),_0x52f245(0x1b0),_0x52f245(0x178),_0x52f245(0x17b),'payWeChatPrivateKey',_0x52f245(0x16e),'queryMpay',_0x52f245(0x1e7),'payHupi',_0x52f245(0x1d7),'epay\x20--->\x20res:\x20','map','1982241RRoYGe',_0x52f245(0x185),_0x52f245(0x1c9),'jsapi',_0x52f245(0x1a1),_0x52f245(0x19e),_0x52f245(0x195),'device','alipay',_0x52f245(0x1ac),_0x52f245(0x147),_0x52f245(0x1c2),_0x52f245(0x19c),_0x52f245(0x1e3),'order',_0x52f245(0x1f2),_0x52f245(0x1c4),_0x52f245(0x1b2),_0x52f245(0x1ef),_0x52f245(0x1d0),_0x52f245(0x1f3),'scene_info',_0x52f245(0x19b),_0x52f245(0x1dc),_0x52f245(0x149),_0x52f245(0x16f),_0x52f245(0x152),_0x52f245(0x179),_0x52f245(0x1c8),_0x52f245(0x17e),_0x52f245(0x1b6),'queryEpay',_0x52f245(0x1ed),_0x52f245(0x1e8),_0x52f245(0x1e9),_0x52f245(0x145),'failed','8763909IepAnw','BAD_REQUEST',_0x52f245(0x1d5),'payHupiGatewayUrl',_0x52f245(0x159),_0x52f245(0x1f0),_0x52f245(0x17d),_0x52f245(0x17c),_0x52f245(0x1b4),_0x52f245(0x172),_0x52f245(0x1cb),_0x52f245(0x1aa),_0x52f245(0x17a),'transactions_jsapi',_0x52f245(0x13f),'attach',_0x52f245(0x1ce),_0x52f245(0x162),_0x52f245(0x1b8),_0x52f245(0x1ad),_0x52f245(0x19a),_0x52f245(0x198),_0x52f245(0x1c7),_0x52f245(0x184),_0x52f245(0x161),_0x52f245(0x170),_0x52f245(0x177),_0x52f245(0x1ee),_0x52f245(0x181),_0x52f245(0x19f),_0x52f245(0x164),_0x52f245(0x14d),_0x52f245(0x1b3),_0x52f245(0x143),_0x52f245(0x1a0),'3197kQOULO',_0x52f245(0x1de),'userService','order_no',_0x52f245(0x173),_0x52f245(0x1cd),'MD5','1.1'];return _0x3bc2=function(){return _0x2ee3d8;},_0x3bc2();}PayService=__decorate([(0x0,common_1[_0x42adb5(0x1e5)])(),__param(0x0,(0x0,typeorm_1[_0x42adb5(0x23f)])(cramiPackage_entity_1[_0x42adb5(0x1bd)])),__param(0x1,(0x0,typeorm_1[_0x3b42f1(0x16b)])(order_entity_1[_0x42adb5(0x204)])),__metadata(_0x42adb5(0x1cc),[typeorm_2[_0x42adb5(0x1b3)],typeorm_2[_0x42adb5(0x1b3)],userBalance_service_1[_0x42adb5(0x20c)],globalConfig_service_1[_0x42adb5(0x23d)],user_service_1[_0x42adb5(0x1fc)]])],PayService),exports[_0x42adb5(0x1a2)]=PayService;