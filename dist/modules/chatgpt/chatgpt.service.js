'use strict';const _0x14868a=_0x1c31;(function(_0x4c474e,_0x3d5890){const _0x58bb1d=_0x1c31,_0x3e9c85=_0x4c474e();while(!![]){try{const _0x5f3633=-parseInt(_0x58bb1d(0x180))/0x1*(-parseInt(_0x58bb1d(0x1bb))/0x2)+parseInt(_0x58bb1d(0x1c3))/0x3*(-parseInt(_0x58bb1d(0x23c))/0x4)+-parseInt(_0x58bb1d(0x24f))/0x5*(-parseInt(_0x58bb1d(0x255))/0x6)+-parseInt(_0x58bb1d(0x223))/0x7+-parseInt(_0x58bb1d(0x197))/0x8+-parseInt(_0x58bb1d(0x266))/0x9+-parseInt(_0x58bb1d(0x173))/0xa*(-parseInt(_0x58bb1d(0x1f2))/0xb);if(_0x5f3633===_0x3d5890)break;else _0x3e9c85['push'](_0x3e9c85['shift']());}catch(_0x59a965){_0x3e9c85['push'](_0x3e9c85['shift']());}}}(_0x1ebf,0xd2f34));function _0x1ebf(){const _0x29e8b9=['./../user/user.service','userBalanceService','REDIS_PASSWORD','../chatLog/chatLog.service','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','../models/models.service','toISOString','2vGVVxT','ConfigService','validateBalance','REDIS_HOST','./chatPreType.entity','.png','userService','提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！','19398hSjcdz','detail','globalConfigService','addOneIfOdd','saveChatLog','abortController','当前模型不是聊天模型','50559JmkrBk','sendMessageFromOpenAi','setChatBox','This\x20request\x20has\x20been\x20blocked\x20by\x20our\x20content\x20filters','16k','delChatBoxType','appInfo','dall-e-3','typeorm','setHeader','getRequestParams','model','32k','Catch\x20Error\x20','服务异常、请重新试试吧！！！','NineStore','Please\x20check\x20the\x20back-end\x20console','getConfigs','../../common/constants/balance.constant','112vQyNKj','sendMessageFromZhipu','update','preset','UserBalanceService','typeId','InjectRepository','draw','gpt-4','whiteListUser','from','HttpException','result','dall','nineai-chatlog','chatBoxEntity','split','userBanance','count',',\x20消耗积分：\x20','ceil','6771358lKOMSP','findOne','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','user','openaiModel4MaxTokens','openaiModel3MaxTokens16k','text','getRandomDrawKey','DESC','nineStore','Content-type','object','weight','keyv','design:paramtypes','chatPreEntity','130KFDvLt','Injectable','coverImg','uploadService','当前请求已过载、请稍等会儿再试试吧！','b64_json','chat','statusText:','getClientIp','DrawService','gpt-3','model3','config','GptKeysEntity','statusText','delete','chatBoxTypeEntity','env','当前模型key已被封禁','forEach','removeSpecialCharacters','checkAutoReply','shift','130239OTvrFP','setChatPre','../app/app.entity','chatLogService','size',',\x20消耗token:\x20','@nestjs/common','chatGroupService','write','debug','1830815RDfsBx','gpt-4-vision-preview','openaiTimeoutMs','draw\x20paompt\x20info\x20<==**==>\x20','\x20模型名称:\x20','@nestjs/typeorm','./chatPre.entity','end','getAllKeyList','modelsService','缺失必要参数！','Billing\x20hard\x20limit\x20has\x20been\x20reached','buildMessageFromParentMessageId','prompt','getUploadType','80094aumkPu','1106','非法操作！','./helper','formatModelToken','chatPreTypeEntity','maxModelTokens','stringify','FanyiService','is_end','716ndMgzY','uuid','save','function','queryChatPreList','model4','__param','GlobalConfigService','status','defineProperty','metadata','openaiModel3MaxTokens','./chatBox.entity','axios','openaiModel4MaxTokens32kRes','unifiedFormattingResponse','compileNetwork','systemMessage','parse','10oGyGtu','./baidu','../autoreply/autoreply.service','nestjs-config','typeInfo','queryChatBoxType','5100198tbpNim','checkBadWords','绘制图片失败，此次绘画被拒绝了！','../globalConfig/globalConfig.service','UserService','DeductionKey','374296QrOzdk','chat-error\x20<----------------------------------------->','chat-error-detail\x20\x20<----------------------------------------->','push','openaiModel4MaxTokens32k','AutoreplyService','ChatBoxEntity','@keyv/redis','当前分类下有未处理数据不可移除！','deductFromBalance','message','6493743WUDifs','appEntity','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','fanyiService','application/octet-stream;\x20charset=utf-8','post','includes','\x0a\x20Current\x20date:\x20','__decorate','__metadata','filter','openaiBaseUrl','BadwordsService','ChatGroupService','billing','getCurrentModelKeyInfo','getModelProxyUrl','chatSyncFree','Too\x20Many\x20Requests','childList','当前模型调用过于频繁、请重新试试吧！','maxResponseTokens','dall-e\x20draw\x20params:\x20','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','getTokenCount','modelInfo','BAD_REQUEST','./../upload/upload.service','key','10qyCMZw','error:\x20','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','openaiProxyUrl','1950kaEvhm','data','delChatPre','Incorrect\x20API\x20key\x20provided','58360yBGqSf','绘制图片失败，请检查你的提示词是否有非法描述！','badwordsService','toLowerCase','../fanyi/fanyi.service','1241543pSJjuH','assign','__esModule','lockKey','onModuleInit','abort','../userBalance/userBalance.service','Bearer\x20','PAYMENT_REQUIRED','conversationId','mjDraw','getBaseConfig','decorate','AppEntity','getOwnPropertyDescriptor',',\x20key\x20===>\x20','map','error','setData','HttpStatus','usage','close','../../common/utils','4421192usWZZk','REDIS_USER','default','log','length','用户ID:\x20','all','openai-draw\x20error:\x20','../badwords/badwords.service','openaiModel3MaxTokensRes','chatProcess','uploadFile','ChatLogService','gpt-4-1106','getUuid','importDynamic','提供了错误的模型秘钥','delChatBox','configEntity','./chatBoxType.entity','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','195nNCFtP','UploadService','systemPreMessage','https://api.openai.com','find','queryChatPre','proxyUrl','appId'];_0x1ebf=function(){return _0x29e8b9;};return _0x1ebf();}const _0x42605f=_0xc40d;(function(_0x558910,_0x3a5c2c){const _0x4759a3=_0x1c31,_0x4dea16=_0xc40d,_0x40c53b=_0x558910();while(!![]){try{const _0x28eb5e=parseInt(_0x4dea16(0x165))/0x1+parseInt(_0x4dea16(0x1f4))/0x2*(parseInt(_0x4dea16(0x202))/0x3)+parseInt(_0x4dea16(0x139))/0x4+parseInt(_0x4dea16(0x1fb))/0x5+parseInt(_0x4dea16(0x15d))/0x6+parseInt(_0x4dea16(0x129))/0x7*(-parseInt(_0x4dea16(0x163))/0x8)+-parseInt(_0x4dea16(0x1f5))/0x9*(parseInt(_0x4dea16(0x17d))/0xa);if(_0x28eb5e===_0x3a5c2c)break;else _0x40c53b[_0x4759a3(0x25e)](_0x40c53b[_0x4759a3(0x218)]());}catch(_0x2c79a8){_0x40c53b[_0x4759a3(0x25e)](_0x40c53b[_0x4759a3(0x218)]());}}}(_0x42c4,0x20595));function _0xc40d(_0x4a3756,_0x346987){const _0x5962c5=_0x42c4();return _0xc40d=function(_0x23f7d3,_0x51c06f){_0x23f7d3=_0x23f7d3-0xfc;let _0x14e90b=_0x5962c5[_0x23f7d3];return _0x14e90b;},_0xc40d(_0x4a3756,_0x346987);}var __decorate=this&&this[_0x42605f(0x159)]||function(_0x204d58,_0x24bfd4,_0x23b7c7,_0x3f857e){const _0x4305b7=_0x1c31,_0x3fc45a=_0x42605f;var _0x37e2b3=arguments[_0x4305b7(0x19b)],_0x5a6ddf=_0x37e2b3<0x3?_0x24bfd4:_0x3f857e===null?_0x3f857e=Object[_0x3fc45a(0x1b0)](_0x24bfd4,_0x23b7c7):_0x3f857e,_0x5e0c07;if(typeof Reflect===_0x3fc45a(0x1de)&&typeof Reflect[_0x3fc45a(0x1ea)]==='function')_0x5a6ddf=Reflect[_0x3fc45a(0x1ea)](_0x204d58,_0x24bfd4,_0x23b7c7,_0x3f857e);else{for(var _0x5655be=_0x204d58[_0x3fc45a(0x13a)]-0x1;_0x5655be>=0x0;_0x5655be--)if(_0x5e0c07=_0x204d58[_0x5655be])_0x5a6ddf=(_0x37e2b3<0x3?_0x5e0c07(_0x5a6ddf):_0x37e2b3>0x3?_0x5e0c07(_0x24bfd4,_0x23b7c7,_0x5a6ddf):_0x5e0c07(_0x24bfd4,_0x23b7c7))||_0x5a6ddf;}return _0x37e2b3>0x3&&_0x5a6ddf&&Object[_0x3fc45a(0x1c2)](_0x24bfd4,_0x23b7c7,_0x5a6ddf),_0x5a6ddf;},__metadata=this&&this[_0x42605f(0x131)]||function(_0x111ed8,_0xb3f25a){const _0xff3649=_0x42605f;if(typeof Reflect===_0xff3649(0x1de)&&typeof Reflect[_0xff3649(0x1d6)]===_0xff3649(0x171))return Reflect[_0xff3649(0x1d6)](_0x111ed8,_0xb3f25a);},__param=this&&this[_0x14868a(0x242)]||function(_0xf37b7d,_0x3c8d1d){return function(_0x5f182f,_0x3d26b5){_0x3c8d1d(_0x5f182f,_0x3d26b5,_0xf37b7d);};};function _0x42c4(){const _0x75580b=_0x14868a,_0x202b13=['CHAT_TYPE',_0x75580b(0x205),'ChatPreEntity',_0x75580b(0x1d6),_0x75580b(0x1c1),_0x75580b(0x220),'queryUserBalance',_0x75580b(0x1d7),_0x75580b(0x261),_0x75580b(0x257),_0x75580b(0x19c),'imageUrl',_0x75580b(0x18d),'ceil',_0x75580b(0x185),_0x75580b(0x238),_0x75580b(0x1ab),_0x75580b(0x1a7),_0x75580b(0x20c),_0x75580b(0x1a1),'./gptkeys.entity',_0x75580b(0x198),_0x75580b(0x25d),_0x75580b(0x23b),_0x75580b(0x1d5),_0x75580b(0x26e),'https://api.openai.com',_0x75580b(0x273),'OpenAiErrorCodeMessage','1569792gJCZfA',_0x75580b(0x19e),_0x75580b(0x21c),_0x75580b(0x1b4),_0x75580b(0x25c),'/v1/images/generations',_0x75580b(0x1dd),_0x75580b(0x16c),_0x75580b(0x1ca),_0x75580b(0x236),_0x75580b(0x1ce),_0x75580b(0x25f),_0x75580b(0x168),_0x75580b(0x194),_0x75580b(0x1eb),'../../common/constants/errorMessage.constant','sendMessageFromBaidu','queryChatBoxFrontend',_0x75580b(0x1f7),_0x75580b(0x165),_0x75580b(0x23f),'ChatBoxTypeEntity',_0x75580b(0x25a),'configService',_0x75580b(0x190),_0x75580b(0x248),_0x75580b(0x176),_0x75580b(0x21d),_0x75580b(0x17a),_0x75580b(0x1e0),_0x75580b(0x1e5),_0x75580b(0x243),_0x75580b(0x202),_0x75580b(0x22d),_0x75580b(0x225),'REDIS_PORT','400\x20error',_0x75580b(0x1f8),'openaiModel4MaxTokensRes',_0x75580b(0x256),_0x75580b(0x1c0),_0x75580b(0x199),_0x75580b(0x1ec),_0x75580b(0x252),_0x75580b(0x217),_0x75580b(0x20b),_0x75580b(0x1e4),_0x75580b(0x1b9),_0x75580b(0x18b),_0x75580b(0x1a8),_0x75580b(0x214),'当前模型key余额已耗尽',_0x75580b(0x200),_0x75580b(0x22f),_0x75580b(0x1ff),_0x75580b(0x1ae),_0x75580b(0x16a),_0x75580b(0x201),_0x75580b(0x16d),'split',_0x75580b(0x213),_0x75580b(0x170),_0x75580b(0x16b),_0x75580b(0x1c6),_0x75580b(0x251),_0x75580b(0x169),_0x75580b(0x1f3),_0x75580b(0x244),_0x75580b(0x210),_0x75580b(0x20d),'stringify','ModelsService','autoreplyService',_0x75580b(0x1d8),'write','./store',_0x75580b(0x1f9),_0x75580b(0x1e3),_0x75580b(0x1bf),'standard','quality',_0x75580b(0x1a0),_0x75580b(0x1e6),_0x75580b(0x18e),_0x75580b(0x1cc),_0x75580b(0x189),'getMaxTokenFromModelWithOpenAi',_0x75580b(0x19d),_0x75580b(0x249),_0x75580b(0x269),_0x75580b(0x1cd),_0x75580b(0x1c9),_0x75580b(0x21b),_0x75580b(0x19a),'HttpStatus',_0x75580b(0x16f),_0x75580b(0x237),_0x75580b(0x1dc),_0x75580b(0x1b7),_0x75580b(0x1c5),_0x75580b(0x1e2),_0x75580b(0x245),_0x75580b(0x233),'Repository','当前Key余额已不足、请重新再试一次吧！',_0x75580b(0x17f),'checkUserStatus','ConfigEntity',_0x75580b(0x1ef),_0x75580b(0x1aa),_0x75580b(0x24d),_0x75580b(0x21a),'response','ChatgptService','config',_0x75580b(0x22a),'./openai',_0x75580b(0x1ad),_0x75580b(0x1b1),_0x75580b(0x240),'coverImg',_0x75580b(0x246),_0x75580b(0x1e9),'base64',_0x75580b(0x228),'PAINT_TYPE',_0x75580b(0x271),'../globalConfig/config.entity',_0x75580b(0x23a),_0x75580b(0x1fd),_0x75580b(0x226),_0x75580b(0x1e8),'saveUseLog',_0x75580b(0x1fc),_0x75580b(0x1c4),_0x75580b(0x234),_0x75580b(0x211),_0x75580b(0x1e7),_0x75580b(0x216),_0x75580b(0x19f),_0x75580b(0x1a2),_0x75580b(0x18c),_0x75580b(0x1d2),_0x75580b(0x25e),_0x75580b(0x259),_0x75580b(0x174),_0x75580b(0x24c),'floor',_0x75580b(0x212),_0x75580b(0x166),'validateBalance',_0x75580b(0x177),_0x75580b(0x219),_0x75580b(0x20a),_0x75580b(0x1a6),'typeInfo',_0x75580b(0x184),'keyPool',_0x75580b(0x17b),'lockKey',_0x75580b(0x1a9),_0x75580b(0x265),_0x75580b(0x22e),'assistant','gptKeysEntity',_0x75580b(0x1ac),'queryChatBox',_0x75580b(0x17c),_0x75580b(0x21f),_0x75580b(0x230),'chatgpt-ai-web',_0x75580b(0x1b3),_0x75580b(0x1de),_0x75580b(0x1f4),_0x75580b(0x1be),'appEntity',_0x75580b(0x264),_0x75580b(0x178),_0x75580b(0x268),_0x75580b(0x1ee),_0x75580b(0x167),_0x75580b(0x1fb),_0x75580b(0x1f6),_0x75580b(0x1ea),_0x75580b(0x1d1),_0x75580b(0x26a),_0x75580b(0x196),_0x75580b(0x23d),_0x75580b(0x260),_0x75580b(0x1ba),_0x75580b(0x209),'statusCode',_0x75580b(0x192),_0x75580b(0x1b8),_0x75580b(0x1cb),_0x75580b(0x235),'你当前使用的应用已被下架、请删除当前对话开启新的对话吧！',_0x75580b(0x1fe),'getTokenCount',_0x75580b(0x206),_0x75580b(0x26d),'slice','ChatPreTypeEntity',_0x75580b(0x1b0),_0x75580b(0x1fa),_0x75580b(0x241),_0x75580b(0x270),'../chatGroup/chatGroup.service',_0x75580b(0x215),_0x75580b(0x1d9),_0x75580b(0x17e),_0x75580b(0x1c7),_0x75580b(0x263),_0x75580b(0x22c),_0x75580b(0x1da),_0x75580b(0x1a5),'setChatPreType','update',_0x75580b(0x232),'./zhipu',_0x75580b(0x1b6),_0x75580b(0x1b5),_0x75580b(0x23e),'delChatPreType','getRequestParams','Logger',_0x75580b(0x26f),'assign',_0x75580b(0x203),_0x75580b(0x1b2),_0x75580b(0x272),'绘制图片失败，请稍后试试吧！',_0x75580b(0x207),_0x75580b(0x1f5),_0x75580b(0x25b),_0x75580b(0x19b),'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',_0x75580b(0x24e),_0x75580b(0x26c),_0x75580b(0x172),_0x75580b(0x1db)];return _0x42c4=function(){return _0x202b13;},_0x42c4();}Object[_0x42605f(0x1c2)](exports,_0x14868a(0x182),{'value':!![]}),exports[_0x42605f(0x1ce)]=void 0x0;const upload_service_1=require(_0x14868a(0x171)),user_service_1=require(_0x42605f(0x160)),nestjs_config_1=require(_0x42605f(0x188)),common_1=require(_0x42605f(0x205)),errorMessage_constant_1=require(_0x42605f(0x16c)),utils_1=require(_0x42605f(0x109)),axios_1=require(_0x42605f(0x1b5)),userBalance_service_1=require(_0x14868a(0x186)),balance_constant_1=require(_0x42605f(0x1be)),chatLog_service_1=require(_0x42605f(0x1bf)),uuid=require(_0x42605f(0x10a)),config_entity_1=require(_0x42605f(0x1dc)),typeorm_1=require(_0x42605f(0x1eb)),typeorm_2=require(_0x42605f(0x1d9)),badwords_service_1=require(_0x42605f(0x1e8)),autoreply_service_1=require(_0x42605f(0x19d)),gptkeys_entity_1=require(_0x42605f(0x154)),globalConfig_service_1=require(_0x14868a(0x258)),fanyi_service_1=require(_0x42605f(0x1c6)),app_entity_1=require(_0x42605f(0x1b9)),chatGroup_service_1=require(_0x42605f(0x11e)),models_service_1=require(_0x42605f(0x18c)),baidu_1=require(_0x14868a(0x250)),helper_1=require(_0x42605f(0x112)),store_1=require(_0x42605f(0x1a8)),zhipu_1=require(_0x42605f(0x12a)),openai_1=require(_0x42605f(0x1d1)),chatBoxType_entity_1=require(_0x42605f(0x1ca)),chatBox_entity_1=require(_0x42605f(0x176)),chatPre_entity_1=require(_0x14868a(0x229)),chatPreType_entity_1=require(_0x42605f(0x1ab));let ChatgptService=class ChatgptService{constructor(_0x369ace,_0x29445b,_0x42af5a,_0x483d5,_0x5c1ca8,_0x1ded20,_0x45f542,_0x44b349,_0xc74d59,_0x5296cb,_0x5c4cff,_0x1d8f96,_0x439898,_0x1f3fcb,_0x2c14a5,_0x146696,_0x436adf,_0x5708cf){const _0x3fffaa=_0x14868a,_0x3ae86c=_0x42605f;this[_0x3ae86c(0x201)]=_0x369ace,this[_0x3ae86c(0x1fd)]=_0x29445b,this[_0x3fffaa(0x212)]=_0x42af5a,this[_0x3fffaa(0x1ec)]=_0x483d5,this[_0x3ae86c(0xfe)]=_0x5c1ca8,this[_0x3ae86c(0x1bd)]=_0x1ded20,this[_0x3ae86c(0x196)]=_0x45f542,this[_0x3ae86c(0x174)]=_0x44b349,this[_0x3fffaa(0x1b5)]=_0xc74d59,this[_0x3ae86c(0x15f)]=_0x5296cb,this[_0x3ae86c(0x144)]=_0x5c4cff,this[_0x3ae86c(0x141)]=_0x1d8f96,this[_0x3fffaa(0x17d)]=_0x439898,this['autoreplyService']=_0x1f3fcb,this[_0x3ae86c(0x1c0)]=_0x2c14a5,this[_0x3ae86c(0x1b6)]=_0x146696,this[_0x3ae86c(0x145)]=_0x436adf,this[_0x3ae86c(0x124)]=_0x5708cf,this[_0x3ae86c(0x104)]=null,this[_0x3ae86c(0x1af)]=[],this[_0x3ae86c(0x1fa)]={'list3':[],'list4':[]};}async[_0x42605f(0x1f9)](){const _0x18ad00=_0x14868a,_0x5721a1=_0x42605f;let _0x2ed2da=await(0x0,utils_1[_0x5721a1(0x1f7)])(_0x5721a1(0x207)),_0x44eebe=await(0x0,utils_1[_0x5721a1(0x1f7)])(_0x18ad00(0x262)),_0x18629b=await(0x0,utils_1[_0x5721a1(0x1f7)])(_0x5721a1(0x193));_0x2ed2da=(_0x2ed2da===null||_0x2ed2da===void 0x0?void 0x0:_0x2ed2da[_0x5721a1(0x186)])?_0x2ed2da[_0x5721a1(0x186)]:_0x2ed2da,_0x44eebe=(_0x44eebe===null||_0x44eebe===void 0x0?void 0x0:_0x44eebe[_0x5721a1(0x186)])?_0x44eebe[_0x5721a1(0x186)]:_0x44eebe,_0x18629b=(_0x18629b===null||_0x18629b===void 0x0?void 0x0:_0x18629b[_0x5721a1(0x186)])?_0x18629b[_0x5721a1(0x186)]:_0x18629b;const {ChatGPTAPI:_0x5273c4,ChatGPTError:_0x4ca801,ChatGPTUnofficialProxyAPI:_0x38d838}=_0x2ed2da,_0x56e751=+process[_0x5721a1(0x199)][_0x5721a1(0x180)],_0x50fad7=process[_0x5721a1(0x199)][_0x5721a1(0xfd)],_0x56eeee=process[_0x18ad00(0x213)][_0x5721a1(0x12b)],_0x5ec750=process[_0x5721a1(0x199)][_0x5721a1(0x155)],_0x4a4dd8='redis://'+(_0x5ec750||'')+':'+(_0x56eeee||'')+'@'+_0x50fad7+':'+_0x56e751,_0x3d13e1=new _0x44eebe(_0x4a4dd8),_0x2ebfb0=new _0x18629b({'store':_0x3d13e1,'namespace':_0x5721a1(0x16b)});this[_0x5721a1(0x104)]=new store_1[(_0x5721a1(0x120))]({'store':_0x2ebfb0,'namespace':_0x18ad00(0x208)});}async[_0x14868a(0x1d4)](_0x346de5,_0x5513cb,_0x2eab73,_0x27ffa3=null){const _0x34a885=_0x14868a,_0x40ded2=_0x42605f;var _0x42bcef;!_0x27ffa3&&(_0x27ffa3=(_0x42bcef=await this[_0x40ded2(0x124)][_0x34a885(0x18b)]())===null||_0x42bcef===void 0x0?void 0x0:_0x42bcef[_0x40ded2(0x1bc)]);const {timeout:timeout=0x3c}=_0x2eab73,{topN:_0x1858df,model:_0x4c1929}=_0x27ffa3,{parentMessageId:parentMessageId=0x0}=_0x346de5,_0x793af4=await this[_0x40ded2(0x1c0)][_0x40ded2(0x13f)]([_0x40ded2(0x17f)]),_0x45411e=timeout*0x3e8||_0x793af4||0x64*0x3e8,_0x5dd472={'parentMessageId':parentMessageId,'timeoutMs':+_0x45411e,'completionParams':{'model':_0x4c1929,'temperature':_0x1858df}};return _0x5513cb&&(_0x5dd472[_0x40ded2(0x1cb)]=_0x5513cb),_0x5dd472;}async[_0x42605f(0x103)](_0x251b02){const _0x114415=_0x14868a,_0x4ff50d=_0x42605f,_0x259e78=await this[_0x114415(0x22c)][_0x4ff50d(0x1a9)](),_0x36483f=await this[_0x4ff50d(0x1c0)][_0x114415(0x1db)]([_0x4ff50d(0x194)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x2e4583,model:_0x4c3fa9}=_0x259e78,_0x1d8de3=await this[_0x4ff50d(0x1f2)](_0x259e78),{context:_0x421100}=await this[_0x4ff50d(0x104)][_0x4ff50d(0x192)](_0x251b02,{'parentMessageId':'','systemMessage':_0x36483f});try{const _0x139353=await(0x0,openai_1[_0x4ff50d(0x111)])(_0x421100,{'apiKey':(0x0,utils_1[_0x4ff50d(0x1e7)])(_0x2e4583),'model':_0x4c3fa9,'proxyUrl':_0x1d8de3,'onProgress':null});return _0x139353===null||_0x139353===void 0x0?void 0x0:_0x139353[_0x114415(0x1f8)];}catch(_0x5adfda){console[_0x4ff50d(0x1ba)](_0x4ff50d(0x1ee),_0x5adfda);}}async[_0x42605f(0x153)](_0xff9c7e,_0x10f3a3,_0x4ea51d){const _0x5c37a3=_0x14868a,_0xf107fa=_0x42605f;var _0x1dc4f4,_0xdd90bd,_0x2ec365,_0x5bc949;const _0xc42ff8=_0x10f3a3[_0x5c37a3(0x1c8)],{options:options={},appId:_0x12d663,cusromPrompt:_0xd65d5c,systemMessage:systemMessage=''}=_0xff9c7e;let _0x1997a4=systemMessage;const {parentMessageId:_0x36520}=options,{prompt:_0x1d5430,imageUrl:_0x418996,model:_0x325cc0}=_0xff9c7e,{groupId:_0x2b80e9,usingNetwork:_0x3d9e85}=options,_0x437a69=await this[_0xf107fa(0x145)]['getGroupInfoFromId'](_0x2b80e9),_0x272aed=(_0x437a69===null||_0x437a69===void 0x0?void 0x0:_0x437a69[_0xf107fa(0x1cf)])?JSON[_0xf107fa(0x13c)](_0x437a69[_0x5c37a3(0x20e)]):await this['modelsService'][_0xf107fa(0x18d)](),{keyType:_0xc8d004,model:_0xc4e644,topN:_0x415db5,systemMessage:_0x1bbec4,rounds:_0x3421b4}=_0x272aed['modelInfo'];let _0x1c8b92=null;!_0xd65d5c?_0x1c8b92=await this[_0xf107fa(0x124)][_0xf107fa(0x170)](_0xc4e644):_0x1c8b92=await this[_0x5c37a3(0x22c)][_0x5c37a3(0x1f9)]();if(!_0x1c8b92)throw new common_1[(_0xf107fa(0x1e0))](_0x5c37a3(0x175),common_1['HttpStatus'][_0xf107fa(0x19a)]);const {deduct:_0x407cdd,isTokenBased:_0x2d3c68,tokenFeeRatio:_0x456f66,deductType:_0x110085,key:_0x49476e,secret:_0x48dd66,modelName:_0x48ec0d,id:_0x1777b2,accessToken:_0x16a266}=_0x1c8b92;await this['userService'][_0xf107fa(0x1c7)](_0x10f3a3[_0x5c37a3(0x1f5)]),await this[_0xf107fa(0x12c)][_0x5c37a3(0x1bd)](_0x10f3a3,_0x110085===0x1?_0xf107fa(0x1a2):_0xf107fa(0x11c),_0x407cdd),_0x4ea51d&&_0x4ea51d[_0x5c37a3(0x1d3)](_0xf107fa(0x1e2),_0xf107fa(0x108)),await this['badwordsService'][_0x5c37a3(0x256)](_0x1d5430,_0x10f3a3['user']['id']);const _0x52dc3c=await this[_0xf107fa(0x1a5)][_0xf107fa(0x189)](_0x1d5430);if(_0x52dc3c&&_0x4ea51d){const _0x38f162={'message':_0x52dc3c,'code':0x1f4};return _0x4ea51d[_0x5c37a3(0x221)](JSON[_0xf107fa(0x1a3)](_0x38f162)),_0x4ea51d[_0x5c37a3(0x22a)]();}if(_0x12d663){const _0x4f841a=await this[_0xf107fa(0xfe)][_0xf107fa(0x19f)]({'where':{'id':_0x12d663,'status':(0x0,typeorm_1['In'])([0x1,0x3,0x4,0x5])}});if(!_0x4f841a)throw new common_1[(_0xf107fa(0x1e0))](_0xf107fa(0x113),common_1[_0xf107fa(0x1bb)][_0xf107fa(0x19a)]);_0x4f841a[_0xf107fa(0x17a)]&&(_0x1997a4=_0x4f841a[_0xf107fa(0x17a)]);}else{if(_0xd65d5c)_0x1997a4=systemMessage;else{if(_0x1bbec4)_0x1997a4=_0x1bbec4;else{const _0x34cc95=new Date()[_0xf107fa(0x10c)]()[_0x5c37a3(0x1ed)]('T')[0x0],_0x3f1359=await this[_0xf107fa(0x1c0)][_0xf107fa(0x13f)]([_0x5c37a3(0x1ae)]);_0x1997a4=_0x3f1359+(_0xf107fa(0x117)+_0x34cc95);}}}let _0x5dba41='';if(_0x3d9e85){_0x5dba41=await(0x0,utils_1[_0xf107fa(0x1ef)])(_0x1d5430);const _0x379956=new Date()[_0xf107fa(0x10c)]()[_0xf107fa(0x198)]('T')[0x0],_0x497b0b=await this[_0xf107fa(0x1c0)][_0xf107fa(0x13f)]([_0x5c37a3(0x1ae)]);_0x1997a4=_0x497b0b+(_0xf107fa(0x117)+_0x379956);}const _0x114be5=await this[_0xf107fa(0x12f)](options,_0x1997a4,_0x1c8b92,_0x272aed[_0xf107fa(0x1bc)]),{maxModelTokens:maxModelTokens=0x1f40,maxResponseTokens:maxResponseTokens=0x1000,key:_0x348c6f}=_0x1c8b92;_0x4ea51d&&_0x4ea51d[_0xf107fa(0x1a0)](0xc8);let _0xf3fb5d=null,_0x17003e=null;try{if(_0x4ea51d){let _0x2ff39d=null,_0x1f0d72=![];_0x4ea51d['on'](_0x5c37a3(0x195),async()=>{const _0x17cefa=_0x5c37a3,_0x6e42f6=_0xf107fa;if(_0x1f0d72)return;_0xc42ff8[_0x6e42f6(0x14e)]();const _0x1fc190=await(0x0,openai_1[_0x17cefa(0x16e)])(_0x1d5430)||0x0,_0x514aa3=await(0x0,openai_1[_0x6e42f6(0x115)])(_0x2ff39d===null||_0x2ff39d===void 0x0?void 0x0:_0x2ff39d[_0x6e42f6(0x182)])||0x0,_0x1280c2=_0x1fc190+_0x514aa3,_0x2b9875=(0x0,utils_1[_0x6e42f6(0x1f6)])(_0x10f3a3);await this[_0x17cefa(0x21c)][_0x17cefa(0x1c7)]({'appId':_0x12d663,'curIp':_0x2b9875,'userId':_0x10f3a3[_0x6e42f6(0x138)]['id'],'type':balance_constant_1[_0x17cefa(0x25a)]['CHAT_TYPE'],'prompt':_0x1d5430,'imageUrl':_0x418996,'activeModel':_0x325cc0,'answer':'','promptTokens':_0x1fc190,'completionTokens':0x0,'totalTokens':_0x1fc190,'model':_0xc4e644,'role':_0x6e42f6(0x138),'groupId':_0x2b80e9,'requestOptions':JSON[_0x6e42f6(0x1a3)]({'options':null,'prompt':_0x1d5430})}),await this[_0x6e42f6(0x15f)][_0x17cefa(0x1c7)]({'appId':_0x12d663,'curIp':_0x2b9875,'userId':_0x10f3a3['user']['id'],'type':balance_constant_1[_0x6e42f6(0x173)][_0x6e42f6(0x140)],'prompt':_0x1d5430,'answer':_0x2ff39d===null||_0x2ff39d===void 0x0?void 0x0:_0x2ff39d[_0x6e42f6(0x182)],'promptTokens':_0x1fc190,'completionTokens':_0x514aa3,'totalTokens':_0x1280c2,'model':_0xc4e644,'role':_0x6e42f6(0x200),'groupId':_0x2b80e9,'requestOptions':JSON[_0x17cefa(0x239)]({'options':{'model':_0xc4e644,'temperature':_0x415db5},'prompt':_0x1d5430}),'conversationOptions':JSON[_0x6e42f6(0x1a3)]({'conversationId':_0x2ff39d===null||_0x2ff39d===void 0x0?void 0x0:_0x2ff39d['conversationId'],'model':_0xc4e644,'parentMessageId':_0x2ff39d===null||_0x2ff39d===void 0x0?void 0x0:_0x2ff39d['id'],'temperature':_0x415db5})});let _0x42c384=_0x407cdd;_0x2d3c68===!![]&&(_0x42c384=Math[_0x17cefa(0x1f1)](_0x407cdd*_0x1280c2/_0x456f66)),await this[_0x17cefa(0x1b5)][_0x6e42f6(0xff)](_0x10f3a3[_0x6e42f6(0x138)]['id'],_0x17cefa(0x1d5)+(_0x110085===0x1?0x3:0x4),_0x42c384,_0x1280c2);});if(Number(_0xc8d004)===0x1){const {key:_0x324f6f,maxToken:_0x6dc98,maxTokenRes:_0x172ff0,proxyResUrl:_0x52d2af}=await this[_0xf107fa(0x166)](_0x1c8b92),{parentMessageId:_0xdd84d5,completionParams:_0x527554,systemMessage:_0x12c329}=_0x114be5,{model:_0x3004f6,temperature:_0x296ec7}=_0x527554,{context:_0x5e60dc}=await this[_0xf107fa(0x104)][_0xf107fa(0x192)](_0x3d9e85?_0x5dba41:_0x1d5430,{'parentMessageId':_0xdd84d5,'systemMessage':_0x12c329,'maxModelToken':_0x6dc98,'maxResponseTokens':_0x172ff0,'maxRounds':(0x0,helper_1[_0xf107fa(0x19c)])(_0x3421b4),'imageUrl':_0x418996,'activeModel':_0x325cc0});let _0x467fe1=!![];_0xf3fb5d=await(0x0,openai_1[_0xf107fa(0x111)])(_0x5e60dc,{'maxToken':_0x6dc98,'maxTokenRes':_0x172ff0,'apiKey':_0x49476e,'model':_0x3004f6,'prompt':_0x1d5430,'activeModel':_0x325cc0,'imageUrl':_0x418996,'temperature':_0x296ec7,'proxyUrl':_0x52d2af,'onProgress':_0x2623da=>{const _0x52b065=_0x5c37a3,_0x3a807c=_0xf107fa;_0x4ea51d[_0x3a807c(0x1a7)](_0x467fe1?JSON[_0x52b065(0x239)](_0x2623da):'\x0a'+JSON[_0x3a807c(0x1a3)](_0x2623da)),_0x2ff39d=_0x2623da,_0x467fe1=![];}},this[_0xf107fa(0x141)]),_0x1f0d72=!![];}if(Number(_0xc8d004)===0x2){let _0x538416=!![];const {context:_0x24204c}=await this[_0xf107fa(0x104)][_0xf107fa(0x192)](_0x3d9e85?_0x5dba41:_0x1d5430,{'parentMessageId':_0x36520,'maxRounds':(0x0,helper_1[_0xf107fa(0x19c)])(_0x3421b4)});_0xf3fb5d=await(0x0,baidu_1[_0xf107fa(0x16d)])(_0x3d9e85?_0x5dba41:_0x24204c,{'temperature':_0x415db5,'accessToken':_0x16a266,'model':_0xc4e644,'onProgress':_0x36433a=>{const _0x1b7c46=_0x5c37a3,_0x51da10=_0xf107fa;_0x4ea51d[_0x51da10(0x1a7)](_0x538416?JSON[_0x51da10(0x1a3)](_0x36433a):'\x0a'+JSON[_0x1b7c46(0x239)](_0x36433a)),_0x538416=![],_0x2ff39d=_0x36433a;}}),_0x1f0d72=!![];}if(Number(_0xc8d004)===0x3){let _0x1e6d13=!![];const {context:_0x4f8e6a}=await this[_0xf107fa(0x104)][_0xf107fa(0x192)](_0x3d9e85?_0x5dba41:_0x1d5430,{'parentMessageId':_0x36520,'maxRounds':(0x0,helper_1[_0xf107fa(0x19c)])(_0x3421b4)});_0xf3fb5d=await(0x0,zhipu_1[_0xf107fa(0x209)])(_0x3d9e85?_0x5dba41:_0x4f8e6a,{'temperature':_0x415db5,'key':_0x348c6f,'model':_0xc4e644,'onProgress':_0x3e41f1=>{const _0x1cc855=_0xf107fa;_0x4ea51d[_0x1cc855(0x1a7)](_0x1e6d13?JSON[_0x1cc855(0x1a3)](_0x3e41f1):'\x0a'+JSON[_0x1cc855(0x1a3)](_0x3e41f1)),_0x1e6d13=![],_0x2ff39d=_0x3e41f1;}}),_0x1f0d72=!![];}const _0x321686={'id':this[_0xf107fa(0x104)][_0xf107fa(0x126)](),'text':_0x1d5430,'role':_0xf107fa(0x138),'name':undefined,'usage':null,'imageUrl':_0x418996,'activeModel':_0x325cc0,'parentMessageId':_0x36520,'conversationId':_0xf3fb5d===null||_0xf3fb5d===void 0x0?void 0x0:_0xf3fb5d[_0xf107fa(0x1b2)]};_0x17003e={'model':_0xc4e644,'parentMessageId':_0x36520},await this[_0xf107fa(0x104)][_0xf107fa(0x10f)](_0x321686);const _0x150430={'id':_0xf3fb5d['id'],'text':_0xf3fb5d[_0xf107fa(0x182)],'role':_0xf107fa(0x200),'name':undefined,'usage':_0xf3fb5d===null||_0xf3fb5d===void 0x0?void 0x0:_0xf3fb5d[_0xf107fa(0x16a)],'imageUrl':_0x418996,'parentMessageId':_0x321686['id'],'conversationId':_0xf3fb5d===null||_0xf3fb5d===void 0x0?void 0x0:_0xf3fb5d[_0xf107fa(0x1b2)]};await this[_0xf107fa(0x104)][_0xf107fa(0x10f)](_0x150430),_0x17003e={'model':_0xc4e644,'parentMessageId':_0x321686['id']};}else{const {key:_0x1c718c,maxToken:_0x156643,maxTokenRes:_0x3800e1,proxyResUrl:_0x4dfd15}=await this[_0xf107fa(0x166)](_0x1c8b92),{parentMessageId:_0x5dfd7a,completionParams:_0x110a36,systemMessage:_0x1db972}=_0x114be5,{model:_0x361975,temperature:_0x59ab65}=_0x110a36,{context:_0x2b8bcd}=await this[_0xf107fa(0x104)][_0xf107fa(0x192)](_0x3d9e85?_0x5dba41:_0x1d5430,{'parentMessageId':_0x5dfd7a,'systemMessage':_0x1db972,'maxRounds':(0x0,helper_1[_0x5c37a3(0x1c6)])(_0x3421b4)});_0xf3fb5d=await(0x0,openai_1[_0xf107fa(0x111)])(_0x2b8bcd,{'apiKey':_0x49476e,'model':_0x361975,'temperature':_0x59ab65,'proxyUrl':_0x4dfd15,'onProgress':null,'prompt':_0x1d5430});}let _0x2efa2c=null,_0x195cd0=null;_0xc4e644[_0xf107fa(0x13d)](_0xf107fa(0x106))?_0x2efa2c=((_0x1dc4f4=_0xf3fb5d[_0xf107fa(0x1e3)])===null||_0x1dc4f4===void 0x0?void 0x0:_0x1dc4f4[_0xf107fa(0x16a)])||{'prompt_tokens':0x1,'completion_tokens':0x1,'total_tokens':0x2}:_0x195cd0=await(0x0,helper_1[_0x5c37a3(0x24b)])(_0xc8d004,_0xf3fb5d,_0x17003e);const {prompt_tokens:_0x486ee2,completion_tokens:_0x3fc55d,total_tokens:_0x2b4486}=_0xc4e644[_0xf107fa(0x13d)](_0xf107fa(0x106))?_0x2efa2c:_0x195cd0[_0xf107fa(0x16a)];let _0x3bc4a7=_0x407cdd;_0x2d3c68===!![]&&(_0x3bc4a7=Math[_0xf107fa(0x14d)](_0x407cdd*_0x2b4486/_0x456f66)),(await this[_0xf107fa(0x12c)][_0xf107fa(0xff)](_0x10f3a3[_0xf107fa(0x138)]['id'],_0xf107fa(0x158)+(_0x110085===0x1?0x3:0x4),_0x3bc4a7,_0x2b4486),await this[_0xf107fa(0x124)][_0xf107fa(0x1e1)](_0x1777b2,_0x2b4486));const _0x37c47e=(0x0,utils_1['getClientIp'])(_0x10f3a3);await this[_0xf107fa(0x15f)][_0xf107fa(0x122)]({'appId':_0x12d663,'curIp':_0x37c47e,'userId':_0x10f3a3[_0xf107fa(0x138)]['id'],'type':balance_constant_1[_0xf107fa(0x173)]['CHAT_TYPE'],'prompt':_0x1d5430,'imageUrl':_0x418996,'activeModel':_0x325cc0,'answer':'','promptTokens':_0x486ee2,'completionTokens':0x0,'totalTokens':_0x2b4486,'model':_0xc4e644,'role':_0xf107fa(0x138),'groupId':_0x2b80e9,'requestOptions':JSON[_0xf107fa(0x1a3)]({'options':null,'prompt':_0x1d5430})}),await this[_0x5c37a3(0x21c)][_0xf107fa(0x122)]({'appId':_0x12d663,'curIp':_0x37c47e,'userId':_0x10f3a3[_0xf107fa(0x138)]['id'],'type':balance_constant_1[_0xf107fa(0x173)][_0xf107fa(0x140)],'prompt':_0x1d5430,'imageUrl':_0xf3fb5d===null||_0xf3fb5d===void 0x0?void 0x0:_0xf3fb5d[_0xf107fa(0x14b)],'answer':_0xf3fb5d[_0xf107fa(0x182)],'promptTokens':_0x486ee2,'completionTokens':_0x3fc55d,'totalTokens':_0x2b4486,'model':_0xc4e644,'role':_0xf107fa(0x200),'groupId':_0x2b80e9,'requestOptions':JSON['stringify']({'options':{'model':_0xc4e644,'temperature':_0x415db5},'prompt':_0x1d5430}),'conversationOptions':JSON[_0x5c37a3(0x239)]({'conversationId':_0xf3fb5d[_0xf107fa(0x1b2)],'model':_0xc4e644,'parentMessageId':_0xf3fb5d['id'],'temperature':_0x415db5})}),common_1[_0xf107fa(0x130)][_0x5c37a3(0x222)](_0xf107fa(0x14a)+_0x10f3a3[_0xf107fa(0x138)]['id']+_0x5c37a3(0x227)+_0x48ec0d+'-'+_0x325cc0+_0x5c37a3(0x21e)+_0x2b4486+_0x5c37a3(0x1f0)+_0x3bc4a7,_0xf107fa(0x1ce));const _0x144878=await this[_0x5c37a3(0x1b5)][_0xf107fa(0x146)](_0x10f3a3[_0xf107fa(0x138)]['id']);return _0xf3fb5d[_0xf107fa(0x102)]=Object[_0xf107fa(0x132)]({},_0x144878),_0xf3fb5d[_0xf107fa(0x1d7)]&&(_0xf3fb5d[_0xf107fa(0x1d7)]=''),_0xf3fb5d[_0xf107fa(0x157)]=!![],_0x4ea51d?_0x4ea51d[_0xf107fa(0x1a7)]('\x0a'+JSON[_0xf107fa(0x1a3)](_0xf3fb5d)):_0xf3fb5d[_0xf107fa(0x182)];}catch(_0x56961e){console[_0xf107fa(0x1ba)](_0xf107fa(0x161),_0x49476e,_0x56961e);const _0x14f22a=(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x10e)])||0x190,_0x2d34d6=((_0xdd90bd=_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x1cd)])===null||_0xdd90bd===void 0x0?void 0x0:_0xdd90bd[_0xf107fa(0x1a0)])||(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x10e)])||0x190;console[_0x5c37a3(0x19a)](_0xf107fa(0x156),'code:\x20',_0x14f22a,_0xf107fa(0x1fe),_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x1fe)],_0xf107fa(0x10d),(_0x2ec365=_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x1cd)])===null||_0x2ec365===void 0x0?void 0x0:_0x2ec365[_0x5c37a3(0x210)],_0xf107fa(0x1a0),(_0x5bc949=_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x1cd)])===null||_0x5bc949===void 0x0?void 0x0:_0x5bc949[_0xf107fa(0x1a0)]);if(_0x56961e[_0xf107fa(0x1a0)]&&_0x56961e[_0x5c37a3(0x244)]===0x192){const _0x14d491={'message':_0xf107fa(0x147)+_0x56961e[_0xf107fa(0x1fe)],'code':0x192};if(_0x4ea51d)return _0x4ea51d[_0xf107fa(0x1a7)](JSON[_0xf107fa(0x1a3)](_0x14d491));else throw new common_1[(_0xf107fa(0x1e0))](_0x56961e[_0xf107fa(0x1fe)],common_1['HttpStatus'][_0x5c37a3(0x188)]);}if(!_0x2d34d6){if(_0x4ea51d)return _0x4ea51d[_0xf107fa(0x1a7)](JSON[_0xf107fa(0x1a3)]({'message':_0x56961e[_0xf107fa(0x1fe)],'code':0x1f4}));else throw new common_1[(_0x5c37a3(0x1e8))](_0x56961e[_0xf107fa(0x1fe)],common_1[_0xf107fa(0x1bb)][_0xf107fa(0x19a)]);}let _0x3ca4af=errorMessage_constant_1[_0xf107fa(0x15c)][_0x2d34d6]?errorMessage_constant_1[_0xf107fa(0x15c)][_0x2d34d6]:_0xf107fa(0x1a6);(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x1fe)][_0xf107fa(0x13d)](_0xf107fa(0x197)))&&Number(_0xc8d004)===0x1&&(await this[_0xf107fa(0x124)][_0x5c37a3(0x183)](_0x1777b2,_0xf107fa(0x110),-0x1),_0x3ca4af=_0xf107fa(0x18f)),(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x10e)])===0x1ad&&_0x56961e[_0xf107fa(0x1fe)]['includes'](_0x5c37a3(0x164))&&Number(_0xc8d004)===0x1&&(await this[_0xf107fa(0x124)][_0xf107fa(0x1fc)](_0x1777b2,_0xf107fa(0x13b),-0x3),_0x3ca4af=_0xf107fa(0x190)),(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e['statusCode'])===0x1ad&&(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x1a1)])===_0xf107fa(0x169)&&(_0x3ca4af=_0xf107fa(0x195)),(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e['statusCode'])===0x191&&_0x56961e[_0xf107fa(0x1fe)][_0xf107fa(0x13d)](_0xf107fa(0x179))&&Number(_0xc8d004)===0x1&&(await this[_0x5c37a3(0x22c)][_0xf107fa(0x1fc)](_0x1777b2,_0xf107fa(0x151),-0x2),_0x3ca4af=_0x5c37a3(0x1c2)),(_0x56961e===null||_0x56961e===void 0x0?void 0x0:_0x56961e[_0xf107fa(0x10e)])===0x194&&_0x56961e[_0xf107fa(0x1fe)][_0xf107fa(0x13d)](_0xf107fa(0x150))&&Number(_0xc8d004)===0x1&&(await this[_0xf107fa(0x124)][_0x5c37a3(0x183)](_0x1777b2,_0xf107fa(0x1b8),-0x4),_0x3ca4af=_0xf107fa(0x101)),_0x14f22a===0x190&&console[_0xf107fa(0x1ba)](_0xf107fa(0x181),_0x56961e,_0x56961e[_0xf107fa(0x1fe)]);const _0xcf011b={'message':_0x3ca4af||_0xf107fa(0x125),'code':_0x14f22a===0x191?0x190:_0x14f22a||0x1f4};if(_0x4ea51d)return _0x4ea51d['write'](JSON[_0x5c37a3(0x239)](_0xcf011b));else throw new common_1[(_0xf107fa(0x1e0))](_0xcf011b[_0xf107fa(0x1fe)],common_1[_0xf107fa(0x1bb)][_0xf107fa(0x19a)]);}finally{_0x4ea51d&&_0x4ea51d[_0xf107fa(0x1d0)]();}}async[_0x42605f(0x18b)](_0x50df5a,_0x29515c){const _0xad7b57=_0x14868a,_0x77d741=_0x42605f;var _0x39b044,_0x40a284,_0x3a2ae0,_0x52423e;await this[_0xad7b57(0x17d)][_0x77d741(0x184)](_0x50df5a[_0xad7b57(0x230)],_0x29515c[_0x77d741(0x138)]['id']),await this[_0x77d741(0x144)][_0x77d741(0x1c7)](_0x29515c[_0x77d741(0x138)]);const _0x32d037=(_0x50df5a===null||_0x50df5a===void 0x0?void 0x0:_0x50df5a['quality'])==='hd'?0x4:0x2;await this[_0x77d741(0x12c)][_0x77d741(0x1f3)](_0x29515c,_0xad7b57(0x18a),_0x32d037);let _0x1288d9=[];const _0x3f9b56=await this[_0x77d741(0x124)][_0x77d741(0x170)]('dall-e-3'),_0x393ddf=_0x3f9b56===null||_0x3f9b56===void 0x0?void 0x0:_0x3f9b56['id'],{key:_0x4b7700,proxyResUrl:_0xaa7be8}=await this[_0x77d741(0x166)](_0x3f9b56);common_1[_0x77d741(0x130)][_0x77d741(0x1ba)](_0x77d741(0x1df)+_0x50df5a[_0x77d741(0x206)]+_0xad7b57(0x18f)+_0x4b7700,_0x77d741(0x18a));try{const _0x3f3adb=_0xaa7be8+_0x77d741(0x162),_0x3b7b93=Object[_0x77d741(0x132)](Object[_0xad7b57(0x181)]({},_0x50df5a),{'model':_0x77d741(0x107)});console[_0x77d741(0x1ba)](_0x77d741(0x164),_0x3b7b93);const _0x2037de=await axios_1[_0x77d741(0x186)][_0xad7b57(0x26b)](_0x3f3adb,Object[_0x77d741(0x132)](Object[_0x77d741(0x132)]({},_0x3b7b93),{'response_format':_0x77d741(0x137)}),{'headers':{'Authorization':_0xad7b57(0x187)+_0x4b7700}});_0x1288d9=_0x2037de[_0xad7b57(0x178)][_0xad7b57(0x178)];const _0x3f0044=[];for(const _0x279755 of _0x1288d9){const _0x46963c=uuid['v4']()[_0x77d741(0x118)](0x0,0xa)+_0x77d741(0x185),_0x405fc0=Buffer[_0x77d741(0x1e6)](_0x279755[_0x77d741(0x137)],_0x77d741(0x1d8));_0x3f0044[_0x77d741(0x1ec)](this[_0xad7b57(0x205)][_0x77d741(0x1e9)]({'filename':_0x46963c,'buffer':_0x405fc0}));}const _0x5b2e31=await Promise[_0x77d741(0x1b4)](_0x3f0044);await this[_0xad7b57(0x1b5)][_0x77d741(0xff)](_0x29515c[_0x77d741(0x138)]['id'],_0xad7b57(0x18a),(_0x3b7b93===null||_0x3b7b93===void 0x0?void 0x0:_0x3b7b93[_0x77d741(0x1ad)])===_0x77d741(0x1ac)?0x2:0x4,_0x32d037);const _0x1e6b32=(0x0,utils_1[_0x77d741(0x1f6)])(_0x29515c),_0x2c639e=[],_0x9e59af=await this[_0xad7b57(0x205)][_0xad7b57(0x231)](),[_0xffda12,_0x426f48]=_0x50df5a[_0x77d741(0x178)][_0xad7b57(0x1ed)]('x');return _0x5b2e31[_0x77d741(0x11f)](_0x2bf5ff=>{const _0x44d4d5=_0xad7b57,_0x441f28=_0x77d741;_0x2c639e[_0x441f28(0x1ec)](this[_0x441f28(0x15f)][_0x441f28(0x122)]({'curIp':_0x1e6b32,'userId':_0x29515c[_0x44d4d5(0x1f5)]['id'],'type':balance_constant_1[_0x441f28(0x173)][_0x441f28(0x1da)],'prompt':_0x50df5a[_0x441f28(0x206)],'answer':_0x2bf5ff,'fileInfo':JSON[_0x441f28(0x1a3)]({'cosType':_0x9e59af,'width':_0xffda12,'height':_0x426f48,'cosUrl':_0x2bf5ff}),'promptTokens':0x0,'completionTokens':0x0,'totalTokens':0x0,'model':_0x441f28(0x107)}));}),await Promise[_0x77d741(0x1b4)](_0x2c639e),_0x5b2e31;}catch(_0x3a4587){const _0x581878=((_0x39b044=_0x3a4587===null||_0x3a4587===void 0x0?void 0x0:_0x3a4587[_0x77d741(0x1cd)])===null||_0x39b044===void 0x0?void 0x0:_0x39b044[_0x77d741(0x1a0)])||0x1f4;console[_0x77d741(0x1ba)](_0x77d741(0x15e),JSON[_0x77d741(0x1a3)](_0x3a4587),_0x4b7700,_0x581878);const _0x1f13ee=(_0x52423e=(_0x3a2ae0=(_0x40a284=_0x3a4587===null||_0x3a4587===void 0x0?void 0x0:_0x3a4587[_0x77d741(0x1cd)])===null||_0x40a284===void 0x0?void 0x0:_0x40a284[_0x77d741(0x100)])===null||_0x3a2ae0===void 0x0?void 0x0:_0x3a2ae0[_0xad7b57(0x191)])===null||_0x52423e===void 0x0?void 0x0:_0x52423e['message'];if(_0x581878===0x1ad)throw new common_1[(_0xad7b57(0x1e8))](_0x77d741(0x116),common_1[_0x77d741(0x1bb)][_0x77d741(0x19a)]);if(_0x581878===0x190&&_0x1f13ee[_0xad7b57(0x26c)](_0x77d741(0x1b7)))throw new common_1[(_0x77d741(0x1e0))](_0x77d741(0xfc),common_1[_0x77d741(0x1bb)][_0x77d741(0x19a)]);if(_0x581878===0x190&&_0x1f13ee[_0x77d741(0x13d)](_0x77d741(0x1ff))){await this[_0x77d741(0x124)][_0x77d741(0x1fc)](_0x393ddf,_0xad7b57(0x1b8),-0x1);throw new common_1[(_0x77d741(0x1e0))](_0x77d741(0x1c5),common_1[_0xad7b57(0x193)][_0x77d741(0x19a)]);}if(_0x581878===0x1f4)throw new common_1[(_0x77d741(0x1e0))](_0x77d741(0x204),common_1[_0x77d741(0x1bb)][_0xad7b57(0x170)]);if(_0x581878===0x191)throw new common_1[(_0x77d741(0x1e0))](_0x77d741(0x149),common_1[_0x77d741(0x1bb)][_0x77d741(0x19a)]);throw new common_1[(_0xad7b57(0x1e8))](_0x77d741(0x136),common_1[_0x77d741(0x1bb)][_0x77d741(0x19a)]);}}async[_0x14868a(0x22b)](){const _0x54f1a4=_0x14868a,_0x26cdb2=_0x42605f,_0x3e95ea=await this['gptKeysEntity'][_0x26cdb2(0x11a)]({'where':{'status':0x1},'select':['id',_0x26cdb2(0x13e),_0x26cdb2(0x114),_0x26cdb2(0x158),_0x26cdb2(0x14f),_0x26cdb2(0x19b),_0x26cdb2(0x177),_0x26cdb2(0x17f)]}),_0x21da63=_0x3e95ea[_0x26cdb2(0x11d)](_0x116993=>_0x116993[_0x26cdb2(0x158)][_0x54f1a4(0x26c)](_0x26cdb2(0x152))),_0x685cde=_0x3e95ea[_0x26cdb2(0x11d)](_0x4db998=>_0x4db998[_0x26cdb2(0x158)][_0x26cdb2(0x13d)](_0x26cdb2(0x17b)));this[_0x26cdb2(0x1fa)]={'list3':_0x21da63,'list4':_0x685cde};}async[_0x42605f(0x1f2)](_0x55f3d2){const _0x135cca=_0x14868a,_0x2120fa=_0x42605f,_0x2514a5=await this[_0x2120fa(0x1c0)][_0x135cca(0x1db)]([_0x2120fa(0x1db)]);return(_0x55f3d2===null||_0x55f3d2===void 0x0?void 0x0:_0x55f3d2[_0x2120fa(0x134)])||_0x2514a5||_0x2120fa(0x15a);}async[_0x42605f(0x166)](_0x5edf26){const _0x28acd1=_0x14868a,_0x931205=_0x42605f,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x931205(0x1c0)][_0x931205(0x13f)]([_0x28acd1(0x247),_0x931205(0x1ae),_0x931205(0x16f),'openaiModel3MaxTokens16kRes',_0x931205(0x105),_0x931205(0x183),_0x931205(0x168),_0x28acd1(0x24a),_0x931205(0x1db)]);let _0x473ea5=null,_0x298228=null,_0x39ccc8=null,{model:_0xfce095,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:proxyUrl='',key:_0x40ea97}=_0x5edf26;return _0xfce095[_0x931205(0x121)]()[_0x931205(0x13d)](_0x931205(0x17b))&&(maxModelTokens>=0x2000&&(maxModelTokens=0x2000),_0x298228>=0x1000&&(maxModelTokens=0x1000),_0x473ea5=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x298228=maxResponseTokens||openaiModel4MaxTokensRes||0x1000,_0xfce095[_0x931205(0x121)]()[_0x931205(0x13d)](_0x931205(0x143))&&(maxModelTokens>=0x8000&&(maxModelTokens=0x8000),_0x298228>=0x4000&&(maxModelTokens=0x4000),_0x473ea5=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x298228=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000),_0xfce095[_0x931205(0x121)]()[_0x931205(0x13d)](_0x931205(0x1c3))&&(maxModelTokens>=0x3ffc&&(maxModelTokens=0x3ffc),_0x298228>=0x1000&&(maxModelTokens=0x1000),_0x473ea5=maxModelTokens||0x3ffc,_0x298228=maxResponseTokens||0x1000)),_0xfce095[_0x931205(0x121)]()[_0x931205(0x13d)](_0x28acd1(0x20c))&&(maxModelTokens>=0x1000&&(maxModelTokens=0x1000),_0x298228>=0x7d0&&(maxModelTokens=0x7d0),_0x473ea5=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x298228=maxResponseTokens||openaiModel3MaxTokensRes||0x7d0,_0xfce095[_0x28acd1(0x17e)]()[_0x931205(0x13d)](_0x28acd1(0x1ce))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x298228>=0x2000&&(maxModelTokens=0x2000),_0x473ea5=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x298228=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000),_0xfce095[_0x931205(0x121)]()[_0x931205(0x13d)](_0x28acd1(0x233))&&(maxModelTokens>=0x4000&&(maxModelTokens=0x4000),_0x298228>=0x1000&&(maxModelTokens=0x1000),_0x473ea5=maxModelTokens||0x4000,_0x298228=maxResponseTokens||0x1000)),_0x39ccc8=proxyUrl||openaiBaseUrl||_0x28acd1(0x1af),_0x298228>=_0x473ea5&&(_0x298228=Math[_0x931205(0x1f0)](_0x473ea5/0x2)),{'key':_0x40ea97,'maxToken':_0x473ea5,'maxTokenRes':_0x298228,'proxyResUrl':_0x39ccc8};}async['setChatBoxType'](_0x546294,_0x5f3340){const _0x2b0662=_0x14868a,_0x402c61=_0x42605f;try{const {name:_0x37bbb5,icon:_0x354fa8,order:_0x5479f8,id:_0x501302,status:_0x40a6fc}=_0x5f3340;return _0x501302?await this[_0x402c61(0x1f1)][_0x402c61(0x128)]({'id':_0x501302},{'name':_0x37bbb5,'icon':_0x354fa8,'order':_0x5479f8,'status':_0x40a6fc}):await this[_0x2b0662(0x212)][_0x402c61(0x12d)]({'name':_0x37bbb5,'icon':_0x354fa8,'order':_0x5479f8,'status':_0x40a6fc});}catch(_0x5498ca){console[_0x402c61(0x1ba)](_0x402c61(0x1ee),_0x5498ca);}}async[_0x14868a(0x1cf)](_0x92e66,_0xa9f291){const _0x5a91b3=_0x14868a,_0x3a7051=_0x42605f,{id:_0x3cf131}=_0xa9f291;if(!_0x3cf131)throw new common_1[(_0x3a7051(0x1e0))](_0x5a91b3(0x234),common_1[_0x3a7051(0x1bb)][_0x5a91b3(0x170)]);const _0x434f8d=await this[_0x3a7051(0x187)][_0x3a7051(0x1c9)]({'where':{'typeId':_0x3cf131}});if(_0x434f8d)throw new common_1[(_0x3a7051(0x1e0))](_0x3a7051(0x123),common_1[_0x3a7051(0x1bb)][_0x3a7051(0x19a)]);return await this[_0x3a7051(0x1f1)][_0x3a7051(0x1e5)]({'id':_0x3cf131});}async[_0x14868a(0x254)](){const _0x5be7bb=_0x14868a,_0x7eb1c5=_0x42605f;return await this[_0x5be7bb(0x212)][_0x7eb1c5(0x11a)]({'order':{'order':_0x7eb1c5(0x11b)}});}async[_0x42605f(0x1b1)](_0xa6385e,_0x24c9cf){const _0x60ef14=_0x14868a,_0x28ead8=_0x42605f,{title:_0x38e309,prompt:_0x19f9ed,appId:_0x4257ce,order:_0x222ac1,status:_0xb02d72,typeId:_0x458273,id:_0x4c8fb2,url:_0x17d4f4}=_0x24c9cf;if(!_0x458273)throw new common_1[(_0x60ef14(0x1e8))](_0x28ead8(0x17e),common_1[_0x28ead8(0x1bb)][_0x28ead8(0x19a)]);try{const _0x5b89bb={'title':_0x38e309,'order':_0x222ac1,'status':_0xb02d72,'typeId':_0x458273,'url':_0x17d4f4};return _0x5b89bb[_0x28ead8(0x208)]=_0x4257ce||0x0,_0x5b89bb[_0x28ead8(0x206)]=_0x19f9ed||'',_0x4c8fb2?await this[_0x28ead8(0x187)][_0x60ef14(0x1df)]({'id':_0x4c8fb2},_0x5b89bb):await this[_0x28ead8(0x187)][_0x28ead8(0x12d)](_0x5b89bb);}catch(_0x306696){console[_0x28ead8(0x1ba)](_0x28ead8(0x1ee),_0x306696);}}async[_0x42605f(0x18e)](_0x369924,_0x41dc9c){const _0x1f5297=_0x14868a,_0x7da10e=_0x42605f,{id:_0x3931ae}=_0x41dc9c;if(!_0x3931ae)throw new common_1[(_0x1f5297(0x1e8))](_0x7da10e(0x1e4),common_1[_0x7da10e(0x1bb)]['BAD_REQUEST']);return await this[_0x7da10e(0x187)][_0x7da10e(0x1e5)]({'id':_0x3931ae});}async[_0x42605f(0x203)](){const _0x18745a=_0x14868a,_0x29fad4=_0x42605f,_0x4e4379=await this[_0x18745a(0x1ec)][_0x29fad4(0x11a)]({'order':{'order':_0x18745a(0x1fa)}}),_0x1f9e45=[...new Set(_0x4e4379[_0x29fad4(0x175)](_0x160b8a=>_0x160b8a[_0x29fad4(0x1c1)]))],_0x498fb0=[...new Set(_0x4e4379[_0x29fad4(0x175)](_0x507de2=>_0x507de2[_0x29fad4(0x208)]))],_0x22eda7=await this[_0x29fad4(0x1f1)][_0x18745a(0x1b0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x1f9e45)}}),_0x2a0bdf=await this[_0x18745a(0x267)][_0x29fad4(0x11a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x498fb0)}});return _0x4e4379[_0x29fad4(0x175)](_0x47c0e4=>{const _0x4a426b=_0x18745a,_0x2b4e34=_0x29fad4,{typeId:_0x1b4e72,appId:_0x18884a}=_0x47c0e4;return _0x47c0e4[_0x4a426b(0x253)]=_0x22eda7[_0x4a426b(0x1b0)](_0x448548=>_0x448548['id']===_0x1b4e72),_0x47c0e4[_0x4a426b(0x1d0)]=_0x2a0bdf[_0x2b4e34(0x11a)](_0x5c82fb=>_0x5c82fb['id']===_0x18884a),_0x47c0e4;});}async[_0x42605f(0x16e)](){const _0x31b9c6=_0x14868a,_0x3046a6=_0x42605f,_0x1547b9=await this['chatBoxTypeEntity'][_0x3046a6(0x11a)]({'order':{'order':_0x3046a6(0x11b)},'where':{'status':!![]}}),_0x5c6f88=await this[_0x3046a6(0x187)][_0x3046a6(0x11a)]({'where':{'status':!![]}}),_0x119721=[...new Set(_0x5c6f88[_0x3046a6(0x175)](_0x2ea886=>_0x2ea886['appId']))],_0x38cc3b=await this[_0x3046a6(0xfe)][_0x31b9c6(0x1b0)]({'where':{'id':(0x0,typeorm_1['In'])(_0x119721)}});return _0x5c6f88[_0x3046a6(0x11f)](_0x1f5a36=>{const _0xdda13b=_0x31b9c6,_0xd0a2de=_0x3046a6,_0x6c1c17=_0x38cc3b['find'](_0x4d0f50=>_0x4d0f50['id']===_0x1f5a36[_0xd0a2de(0x208)]);return _0x1f5a36[_0xd0a2de(0x1d5)]=_0x6c1c17===null||_0x6c1c17===void 0x0?void 0x0:_0x6c1c17[_0xdda13b(0x204)],_0x1f5a36;}),_0x1547b9[_0x3046a6(0x175)](_0x82dbe6=>{const _0x2c2531=_0x3046a6;return _0x82dbe6[_0x2c2531(0x19e)]=_0x5c6f88[_0x2c2531(0x11d)](_0x3ffd4=>_0x3ffd4[_0x2c2531(0x1c1)]===_0x82dbe6['id']&&_0x3ffd4[_0x2c2531(0x1a0)]),_0x82dbe6;});}async[_0x42605f(0x127)](_0x3b7a5b,_0x17e8bf){const _0x3115b6=_0x14868a,_0x4c5564=_0x42605f;try{const {name:_0x56f46f,icon:_0x4849e5,order:_0x92032c,id:_0x450ef3,status:_0x3b0e6b}=_0x17e8bf;return _0x450ef3?await this[_0x4c5564(0x1bd)][_0x4c5564(0x128)]({'id':_0x450ef3},{'name':_0x56f46f,'icon':_0x4849e5,'order':_0x92032c,'status':_0x3b0e6b}):await this[_0x3115b6(0x237)][_0x4c5564(0x12d)]({'name':_0x56f46f,'icon':_0x4849e5,'order':_0x92032c,'status':_0x3b0e6b});}catch(_0x23e8a8){console[_0x4c5564(0x1ba)](_0x3115b6(0x174),_0x23e8a8);}}async[_0x42605f(0x12e)](_0x2ee522,_0x51cd9d){const _0x55ed2e=_0x14868a,_0x277408=_0x42605f,{id:_0x430f4a}=_0x51cd9d;if(!_0x430f4a)throw new common_1[(_0x277408(0x1e0))]('非法操作！',common_1[_0x277408(0x1bb)][_0x277408(0x19a)]);const _0x5077b1=await this[_0x277408(0x187)][_0x277408(0x1c9)]({'where':{'typeId':_0x430f4a}});if(_0x5077b1)throw new common_1[(_0x277408(0x1e0))](_0x277408(0x123),common_1[_0x277408(0x1bb)][_0x55ed2e(0x170)]);return await this[_0x277408(0x1bd)][_0x277408(0x1e5)]({'id':_0x430f4a});}async['queryChatPreType'](){const _0x5191e5=_0x42605f;return await this[_0x5191e5(0x1bd)][_0x5191e5(0x11a)]({'order':{'order':_0x5191e5(0x11b)}});}async[_0x42605f(0x1cc)](_0x3bbef1,_0x31adb4){const _0x46ea90=_0x42605f,{title:_0x761b4a,prompt:_0x47f70a,appId:_0x44a42e,order:_0x4577ec,status:_0xc694ea,typeId:_0x43afed,id:_0x528c22,url:_0x3d67de}=_0x31adb4;if(!_0x43afed)throw new common_1[(_0x46ea90(0x1e0))](_0x46ea90(0x17e),common_1[_0x46ea90(0x1bb)][_0x46ea90(0x19a)]);try{const _0x57ddd5={'title':_0x761b4a,'prompt':_0x47f70a,'order':_0x4577ec,'status':_0xc694ea,'typeId':_0x43afed,'url':_0x3d67de};return _0x528c22?await this[_0x46ea90(0x196)][_0x46ea90(0x128)]({'id':_0x528c22},_0x57ddd5):await this[_0x46ea90(0x196)][_0x46ea90(0x12d)](_0x57ddd5);}catch(_0x2dcf87){console[_0x46ea90(0x1ba)](_0x46ea90(0x1ee),_0x2dcf87);}}async[_0x14868a(0x179)](_0xc2f321,_0x31ca1f){const _0x222126=_0x42605f,{id:_0x19a863}=_0x31ca1f;if(!_0x19a863)throw new common_1[(_0x222126(0x1e0))](_0x222126(0x1e4),common_1['HttpStatus'][_0x222126(0x19a)]);return await this[_0x222126(0x196)]['delete']({'id':_0x19a863});}async[_0x42605f(0x1d3)](){const _0x1f27b8=_0x14868a,_0x421331=_0x42605f,_0x5a99a2=await this['chatPreEntity'][_0x1f27b8(0x1b0)]({'order':{'order':_0x421331(0x11b)}}),_0x5956d9=[...new Set(_0x5a99a2[_0x421331(0x175)](_0x1d6929=>_0x1d6929[_0x421331(0x1c1)]))],_0x186641=await this['chatPreTypeEntity'][_0x421331(0x11a)]({'where':{'id':(0x0,typeorm_1['In'])(_0x5956d9)}});return _0x5a99a2[_0x1f27b8(0x190)](_0x4bbf1c=>{const _0x5a0e23=_0x421331,{typeId:_0x2f26b0,appId:_0x4de0c8}=_0x4bbf1c;return _0x4bbf1c[_0x5a0e23(0x1f8)]=_0x186641[_0x5a0e23(0x11a)](_0x2cf9cd=>_0x2cf9cd['id']===_0x2f26b0),_0x4bbf1c;});}async[_0x42605f(0x1d4)](){const _0x24f5d3=_0x42605f,_0x5166b5=await this[_0x24f5d3(0x1bd)][_0x24f5d3(0x11a)]({'order':{'order':_0x24f5d3(0x11b)},'where':{'status':!![]}}),_0x17ac77=await this[_0x24f5d3(0x196)]['find']({'where':{'status':!![]}});return _0x5166b5[_0x24f5d3(0x175)](_0x3071d1=>{const _0x403b1e=_0x1c31,_0x47a125=_0x24f5d3;return _0x3071d1[_0x47a125(0x19e)]=_0x17ac77[_0x47a125(0x11d)](_0x269eee=>_0x269eee[_0x47a125(0x1c1)]===_0x3071d1['id']&&_0x269eee[_0x403b1e(0x244)]),_0x3071d1;});}async[_0x42605f(0x1b3)](_0x3346bf,_0x3e09f5,_0x401128){const _0x27ef24=_0x14868a,_0x3342f5=_0x42605f;let _0x28b3c9=0x1000,_0x5c9a79=0x800;return _0x3346bf[_0x27ef24(0x17e)]()[_0x3342f5(0x13d)](_0x3342f5(0x17b))&&(_0x28b3c9=_0x3e09f5>=0x2004?0x2004:_0x3e09f5,_0x5c9a79=_0x401128>=0x1000?0x1000:_0x401128,_0x3346bf[_0x27ef24(0x17e)]()[_0x27ef24(0x26c)](_0x3342f5(0x143))&&(_0x28b3c9=_0x3e09f5>=0x8000?0x8000:_0x3e09f5,_0x5c9a79=_0x401128>=0x3e80?0x3e80:_0x401128),(_0x3346bf[_0x3342f5(0x121)]()[_0x3342f5(0x13d)](_0x27ef24(0x1a4))||_0x3346bf['toLowerCase']()[_0x3342f5(0x13d)](_0x27ef24(0x224)))&&(_0x28b3c9=_0x3e09f5>=0x1f400?0x1f400:_0x3e09f5,_0x5c9a79=_0x401128>=0x1000?0x1000:_0x401128)),_0x3346bf[_0x3342f5(0x121)]()[_0x3342f5(0x13d)](_0x3342f5(0x152))&&(_0x28b3c9=_0x3e09f5>=0x1000?0x1000:_0x3e09f5,_0x5c9a79=_0x401128>=0x800?0x800:_0x401128,_0x3346bf[_0x3342f5(0x121)]()[_0x27ef24(0x26c)](_0x3342f5(0x167))&&(_0x28b3c9=_0x3e09f5>=0x4000?0x4000:_0x3e09f5,_0x5c9a79=_0x401128>=0x1f40?0x1f40:_0x401128),_0x3346bf[_0x3342f5(0x121)]()[_0x3342f5(0x13d)](_0x3342f5(0x1c3))&&(_0x28b3c9=_0x3e09f5>=0x4000?0x4000:_0x3e09f5,_0x5c9a79=_0x401128>=0x1f40?0x1f40:_0x401128)),{'maxToken':_0x28b3c9,'maxRes':_0x5c9a79};}};function _0x1c31(_0x3ba595,_0x15f9fa){const _0x1ebf8c=_0x1ebf();return _0x1c31=function(_0x1c31c4,_0x1ba2af){_0x1c31c4=_0x1c31c4-0x164;let _0x175c56=_0x1ebf8c[_0x1c31c4];return _0x175c56;},_0x1c31(_0x3ba595,_0x15f9fa);}ChatgptService=__decorate([(0x0,common_1[_0x42605f(0x133)])(),__param(0x0,(0x0,typeorm_2[_0x42605f(0x1aa)])(gptkeys_entity_1[_0x14868a(0x20f)])),__param(0x1,(0x0,typeorm_2[_0x42605f(0x1aa)])(config_entity_1[_0x42605f(0x1c8)])),__param(0x2,(0x0,typeorm_2[_0x14868a(0x1e3)])(chatBoxType_entity_1[_0x42605f(0x172)])),__param(0x3,(0x0,typeorm_2[_0x14868a(0x1e3)])(chatBox_entity_1[_0x42605f(0x148)])),__param(0x4,(0x0,typeorm_2['InjectRepository'])(app_entity_1[_0x42605f(0x14c)])),__param(0x5,(0x0,typeorm_2[_0x42605f(0x1aa)])(chatPreType_entity_1[_0x42605f(0x119)])),__param(0x6,(0x0,typeorm_2[_0x42605f(0x1aa)])(chatPre_entity_1[_0x42605f(0x142)])),__metadata(_0x42605f(0x191),[typeorm_1[_0x42605f(0x1c4)],typeorm_1[_0x42605f(0x1c4)],typeorm_1[_0x42605f(0x1c4)],typeorm_1[_0x42605f(0x1c4)],typeorm_1[_0x42605f(0x1c4)],typeorm_1[_0x42605f(0x1c4)],typeorm_1[_0x42605f(0x1c4)],nestjs_config_1[_0x14868a(0x1bc)],userBalance_service_1[_0x14868a(0x1e1)],chatLog_service_1[_0x14868a(0x1a3)],user_service_1[_0x42605f(0x1ed)],upload_service_1[_0x42605f(0x1d2)],badwords_service_1[_0x42605f(0x135)],autoreply_service_1[_0x42605f(0x10b)],globalConfig_service_1[_0x42605f(0x17c)],fanyi_service_1[_0x42605f(0x1dd)],chatGroup_service_1[_0x42605f(0x15b)],models_service_1[_0x42605f(0x1a4)]])],ChatgptService),exports['ChatgptService']=ChatgptService;